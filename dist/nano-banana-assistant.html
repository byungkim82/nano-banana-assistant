<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜ë…¸ ë°”ë‚˜ë‚˜ í”„ë¡¬í”„íŠ¸ ì–´ì‹œìŠ¤í„´íŠ¸</title>
  <style>
/* ===== variables.css ===== */
/* ===== CSS ë³€ìˆ˜ ===== */
:root {
  /* Primary - ë°”ë‚˜ë‚˜ ì˜ë¡œìš° */
  --color-primary: #FFE135;
  --color-primary-dark: #E6C200;
  --color-primary-light: #FFF59D;

  /* Secondary - ë‹¤í¬ ê·¸ë ˆì´ */
  --color-secondary: #2D3436;
  --color-secondary-light: #636E72;

  /* Accent */
  --color-accent: #6C5CE7;

  /* Status */
  --color-success: #00B894;
  --color-warning: #FDCB6E;
  --color-error: #E17055;

  /* Background */
  --color-bg-primary: #FFFFFF;
  --color-bg-secondary: #F8F9FA;
  --color-bg-tertiary: #E9ECEF;

  /* Text */
  --color-text-primary: #212529;
  --color-text-secondary: #6C757D;
  --color-text-muted: #ADB5BD;

  /* Border */
  --color-border: #DEE2E6;
  --color-border-focus: #6C5CE7;

  /* Typography */
  --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-base: 1rem;
  --font-size-lg: 1.125rem;
  --font-size-xl: 1.25rem;
  --font-size-2xl: 1.5rem;

  /* Spacing */
  --spacing-xs: 0.25rem;
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;

  /* Border Radius */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
}


/* ===== reset.css ===== */
/* ===== ë¦¬ì…‹ & ê¸°ë³¸ ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  color: var(--color-text-primary);
  background-color: var(--color-bg-secondary);
  line-height: 1.6;
}


/* ===== layout.css ===== */
/* ===== ë ˆì´ì•„ì›ƒ ===== */
#app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* í—¤ë” */
.header {
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  padding: var(--spacing-md) var(--spacing-lg);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-md);
}

.header-title {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  font-size: var(--font-size-xl);
  font-weight: 700;
  color: var(--color-secondary);
}

.header-actions {
  display: flex;
  gap: var(--spacing-sm);
}

/* ë©”ì¸ ì»¨í…ì¸  */
.main {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: var(--spacing-lg);
  padding: var(--spacing-lg);
  max-width: 1600px;
  margin: 0 auto;
  width: 100%;
}

/* íŒ¨ë„ */
.panel {
  background: var(--color-bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
}

.panel-header {
  background: var(--color-bg-tertiary);
  padding: var(--spacing-md);
  border-bottom: 1px solid var(--color-border);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.panel-body {
  padding: var(--spacing-lg);
}

/* ===== ì‘ì—… ëª¨ë“œ ë°” ===== */
.work-mode-bar {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) var(--spacing-lg);
  background: var(--color-bg-primary);
  border-bottom: 1px solid var(--color-border);
}

.work-mode-label {
  font-size: var(--font-size-sm);
  font-weight: 500;
  color: var(--color-text-secondary);
}

.work-mode-buttons {
  display: flex;
  gap: var(--spacing-xs);
}

.work-mode-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: var(--spacing-sm) var(--spacing-md);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-md);
  background: var(--color-bg-primary);
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 80px;
}

.work-mode-btn:hover {
  border-color: var(--color-accent);
  background: var(--color-bg-secondary);
}

.work-mode-btn.active {
  border-color: var(--color-accent);
  background: rgba(108, 92, 231, 0.1);
}

.work-mode-btn .mode-icon {
  font-size: var(--font-size-lg);
}

.work-mode-btn .mode-name {
  font-size: var(--font-size-xs);
  font-weight: 500;
  color: var(--color-text-primary);
}

.work-mode-btn .mode-size {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
}

.translate-toggle {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.translate-toggle input {
  width: 16px;
  height: 16px;
  cursor: pointer;
}

/* ===== 3ì—´ ë ˆì´ì•„ì›ƒ ===== */
.main-3col {
  flex: 1;
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  gap: var(--spacing-lg);
  padding: var(--spacing-lg);
  max-width: 1800px;
  margin: 0 auto;
  width: 100%;
}


/* ===== components.css ===== */
/* ===== ë²„íŠ¼ ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-sm) var(--spacing-md);
  border: none;
  border-radius: var(--radius-md);
  font-family: inherit;
  font-size: var(--font-size-sm);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--color-primary);
  color: var(--color-secondary);
}

.btn-primary:hover:not(:disabled) {
  background: var(--color-primary-dark);
}

.btn-secondary {
  background: var(--color-secondary);
  color: white;
}

.btn-secondary:hover:not(:disabled) {
  background: var(--color-secondary-light);
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--color-border);
  color: var(--color-text-secondary);
}

.btn-outline:hover:not(:disabled) {
  background: var(--color-bg-tertiary);
}

.btn-accent {
  background: var(--color-accent);
  color: white;
}

.btn-accent:hover:not(:disabled) {
  opacity: 0.9;
}

.btn-lg {
  padding: var(--spacing-md) var(--spacing-xl);
  font-size: var(--font-size-base);
}

.btn-icon {
  padding: var(--spacing-sm);
  min-width: 36px;
}

.btn-danger {
  color: var(--color-error);
}

.btn-danger:hover {
  background: var(--color-error);
  color: white;
}

/* ===== í¼ ìš”ì†Œ ===== */
.form-group {
  margin-bottom: var(--spacing-md);
}

.form-label {
  display: block;
  margin-bottom: var(--spacing-xs);
  font-weight: 500;
  color: var(--color-text-primary);
}

.form-label .required {
  color: var(--color-error);
}

.form-help {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  margin-top: var(--spacing-xs);
}

.form-input,
.form-textarea,
.form-select {
  width: 100%;
  padding: var(--spacing-sm) var(--spacing-md);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-family: inherit;
  font-size: var(--font-size-base);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
  outline: none;
  border-color: var(--color-border-focus);
  box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
}

.form-textarea {
  min-height: 80px;
  resize: vertical;
}

.form-select {
  cursor: pointer;
  background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236C757D' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
  -webkit-appearance: none;
  appearance: none;
  padding-right: 36px;
}

.form-checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.form-checkbox-label {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: var(--font-size-sm);
  transition: background 0.2s ease;
}

.form-checkbox-label:hover {
  background: var(--color-border);
}

.form-checkbox-label input {
  cursor: pointer;
}

.form-row {
  display: flex;
  gap: var(--spacing-md);
}

.form-row .form-group {
  flex: 1;
}

.form-group-sm {
  max-width: 80px !important;
  flex: 0 0 80px !important;
}

/* ===== í…œí”Œë¦¿ íƒ­ ===== */
.template-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
  padding: var(--spacing-md);
  background: var(--color-bg-tertiary);
  border-bottom: 1px solid var(--color-border);
}

.template-tab {
  padding: var(--spacing-sm) var(--spacing-md);
  border: 1px solid transparent;
  border-radius: var(--radius-md);
  background: transparent;
  font-family: inherit;
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.template-tab:hover {
  background: var(--color-bg-primary);
}

.template-tab.active {
  background: var(--color-primary);
  color: var(--color-secondary);
  font-weight: 600;
}

.template-tab .icon {
  font-size: var(--font-size-lg);
}

.template-tab-divider {
  color: var(--color-text-muted);
  padding: 0 var(--spacing-xs);
  display: flex;
  align-items: center;
}

.template-tab-custom {
  border: 1px dashed var(--color-border);
}

.template-tab-add {
  border: 1px dashed var(--color-accent);
  color: var(--color-accent);
}

.template-tab-add:hover {
  background: rgba(108, 92, 231, 0.1);
}

/* ===== í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ===== */
.prompt-preview {
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  margin-top: var(--spacing-lg);
}

.prompt-preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.prompt-preview-title {
  font-weight: 600;
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
}

.prompt-preview-text {
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
  font-size: var(--font-size-sm);
  line-height: 1.5;
  color: var(--color-text-primary);
  white-space: pre-wrap;
  word-break: break-word;
  min-height: 60px;
}

.prompt-preview-text.empty {
  color: var(--color-text-muted);
  font-style: italic;
}

/* ===== í”„ë¡¬í”„íŠ¸ íƒ­ ===== */
.prompt-tabs {
  display: flex;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-sm);
}

.prompt-tab {
  padding: var(--spacing-xs) var(--spacing-sm);
  border: none;
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  cursor: pointer;
  transition: all 0.2s ease;
}

.prompt-tab.active {
  background: var(--color-accent);
  color: white;
}

/* ===== ë²ˆì—­ ìƒíƒœ ===== */
.translate-status {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  margin-top: var(--spacing-xs);
}

.translate-status.translating {
  color: var(--color-warning);
}

.translate-status.translated {
  color: var(--color-success);
}

/* ===== API ìƒíƒœ ===== */
.api-status {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: var(--font-size-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--radius-md);
}

.api-status.connected {
  background: #D1FAE5;
  color: #065F46;
}

.api-status.disconnected {
  background: #FEE2E2;
  color: #991B1B;
}

.api-status.testing {
  background: #FEF3C7;
  color: #92400E;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
}

/* ===== ì•¡ì…˜ ë°” ===== */
.action-bar {
  display: flex;
  gap: var(--spacing-sm);
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--color-border);
  margin-top: var(--spacing-lg);
}

.action-bar .btn {
  flex: 1;
}

/* ===== ì…ë ¥ ê·¸ë£¹ ===== */
.input-group {
  display: flex;
  gap: var(--spacing-xs);
}

.input-group .form-input {
  flex: 1;
}

/* ===== ì—ëŸ¬ & ì„±ê³µ ë©”ì‹œì§€ ===== */
.error-message {
  background: #FEE2E2;
  border: 1px solid #FECACA;
  color: #991B1B;
  padding: var(--spacing-md);
  border-radius: var(--radius-md);
  margin-top: var(--spacing-md);
  font-size: var(--font-size-sm);
}

.success-message {
  background: #D1FAE5;
  border: 1px solid #A7F3D0;
  color: #065F46;
  padding: var(--spacing-md);
  border-radius: var(--radius-md);
  margin-top: var(--spacing-md);
  font-size: var(--font-size-sm);
}

/* ===== ë¡œë”© ===== */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--color-border);
  border-top-color: var(--color-accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
}

.required {
  color: var(--color-error);
}


/* ===== panels.css ===== */
/* ===== ê²°ê³¼ íŒ¨ë„ ===== */
.result-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  text-align: center;
}

.result-placeholder {
  color: var(--color-text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.result-placeholder-icon {
  font-size: 48px;
  opacity: 0.5;
}

.result-image {
  max-width: 100%;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-md);
}

.result-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
  justify-content: center;
}

/* ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ ===== */
.upload-area {
  border: 2px dashed var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-lg);
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  background: var(--color-bg-secondary);
}

.upload-area:hover,
.upload-area.dragover {
  border-color: var(--color-accent);
  background: rgba(108, 92, 231, 0.05);
}

.upload-area-icon {
  font-size: 32px;
  margin-bottom: var(--spacing-sm);
}

.upload-area-text {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.upload-area-hint {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  margin-top: var(--spacing-xs);
}

/* ===== ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ ===== */
.thumbnail-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.thumbnail-item {
  position: relative;
  aspect-ratio: 1;
  border-radius: var(--radius-sm);
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s ease;
}

.thumbnail-item:hover {
  border-color: var(--color-accent);
}

.thumbnail-item.selected {
  border-color: var(--color-accent);
  box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.3);
}

.thumbnail-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumbnail-item .thumbnail-index {
  position: absolute;
  top: 2px;
  left: 2px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  font-size: var(--font-size-xs);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
}

.thumbnail-item .thumbnail-delete {
  position: absolute;
  top: 2px;
  right: 2px;
  background: var(--color-error);
  color: white;
  border: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 12px;
  display: none;
  align-items: center;
  justify-content: center;
}

.thumbnail-item:hover .thumbnail-delete {
  display: flex;
}

/* ===== ì„ íƒëœ ì´ë¯¸ì§€ ì •ë³´ ===== */
.selected-image-info {
  margin-top: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-md);
}

.selected-image-preview {
  width: 100%;
  aspect-ratio: 4/3;
  object-fit: contain;
  background: var(--color-bg-secondary);
  border-radius: var(--radius-sm);
  margin-bottom: var(--spacing-sm);
}

.selected-image-meta {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

.selected-image-meta p {
  margin-bottom: var(--spacing-xs);
}

.selected-image-actions {
  display: flex;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-sm);
}

/* ===== ê²°ê³¼ íˆìŠ¤í† ë¦¬ ===== */
.result-history {
  display: flex;
  gap: var(--spacing-sm);
  overflow-x: auto;
  padding-bottom: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.result-history-item {
  flex-shrink: 0;
  width: 60px;
  height: 60px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s ease;
}

.result-history-item:hover {
  border-color: var(--color-accent);
}

.result-history-item.selected {
  border-color: var(--color-accent);
}

.result-history-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ===== ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ ===== */
.image-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.image-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.image-modal-content {
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.image-modal-img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: var(--radius-md);
}

.image-modal-close {
  position: absolute;
  top: -40px;
  right: 0;
  background: none;
  border: none;
  color: white;
  font-size: 32px;
  cursor: pointer;
  padding: var(--spacing-sm);
}

.image-modal-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 24px;
  padding: var(--spacing-md);
  cursor: pointer;
  border-radius: var(--radius-md);
  transition: background 0.2s ease;
}

.image-modal-nav:hover {
  background: rgba(255, 255, 255, 0.3);
}

.image-modal-nav.prev {
  left: -60px;
}

.image-modal-nav.next {
  right: -60px;
}

.image-modal-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.image-modal-info {
  color: white;
  font-size: var(--font-size-sm);
  margin-top: var(--spacing-sm);
  text-align: center;
  max-width: 600px;
}

/* ===== ìº”ë²„ìŠ¤ ìƒì„±ê¸° ë²„íŠ¼ ===== */
.canvas-generator-btn-container {
  margin-top: var(--spacing-md);
  text-align: center;
}


/* ===== modals.css ===== */
/* ===== ëª¨ë‹¬ ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease, visibility 0.2s ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--color-bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow: hidden;
  transform: scale(0.95);
  transition: transform 0.2s ease;
}

.modal-overlay.active .modal {
  transform: scale(1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-md) var(--spacing-lg);
  border-bottom: 1px solid var(--color-border);
}

.modal-title {
  font-size: var(--font-size-lg);
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: var(--font-size-xl);
  cursor: pointer;
  color: var(--color-text-muted);
  padding: var(--spacing-xs);
  line-height: 1;
}

.modal-close:hover {
  color: var(--color-text-primary);
}

.modal-body {
  padding: var(--spacing-lg);
  overflow-y: auto;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  border-top: 1px solid var(--color-border);
  background: var(--color-bg-secondary);
}

/* ëª¨ë‹¬ ì‚¬ì´ì¦ˆ ë³€í˜• */
.modal-lg {
  max-width: 700px;
}

.modal-xl {
  max-width: 900px;
}

/* ===== í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ===== */
.history-search {
  margin-bottom: var(--spacing-md);
}

.prompt-history-list {
  max-height: 400px;
  overflow-y: auto;
}

.history-item {
  display: flex;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-sm);
  transition: all 0.2s ease;
}

.history-item:hover {
  border-color: var(--color-accent);
  background: var(--color-bg-secondary);
}

.history-item-content {
  flex: 1;
  min-width: 0;
}

.history-prompt {
  font-size: var(--font-size-sm);
  color: var(--color-text-primary);
  line-height: 1.4;
  word-break: break-word;
}

.history-translated {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  margin-top: var(--spacing-xs);
}

.history-meta {
  display: flex;
  gap: var(--spacing-md);
  margin-top: var(--spacing-sm);
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
}

.history-template {
  background: var(--color-bg-tertiary);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
}

.history-item-actions {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.empty-history {
  text-align: center;
  padding: var(--spacing-xl);
  color: var(--color-text-muted);
}

/* ===== ìº”ë²„ìŠ¤ ìƒì„±ê¸° ===== */
.aspect-ratio-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: var(--spacing-xs);
}

.aspect-ratio-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-sm);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-md);
  background: var(--color-bg-primary);
  cursor: pointer;
  transition: all 0.2s ease;
}

.aspect-ratio-btn:hover {
  border-color: var(--color-accent);
}

.aspect-ratio-btn.active {
  border-color: var(--color-accent);
  background: rgba(108, 92, 231, 0.1);
}

.ratio-preview {
  border-radius: 2px;
}

.ratio-label {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  text-align: center;
}

.size-input-row {
  display: flex;
  align-items: flex-end;
  gap: var(--spacing-sm);
}

.size-input-group {
  flex: 1;
}

.size-input-group label {
  display: block;
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  margin-bottom: var(--spacing-xs);
}

.size-input-group .form-input {
  width: 100%;
}

.size-separator {
  padding-bottom: var(--spacing-sm);
  color: var(--color-text-muted);
}

.size-unit {
  padding-bottom: var(--spacing-sm);
  color: var(--color-text-muted);
  font-size: var(--font-size-sm);
}

.background-options {
  display: flex;
  gap: var(--spacing-md);
}

.background-option {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  cursor: pointer;
  font-size: var(--font-size-sm);
}

.bg-preview {
  width: 24px;
  height: 24px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--color-border);
}

.bg-white {
  background: #FFFFFF;
}

.bg-transparent {
  background: repeating-conic-gradient(#CCCCCC 0% 25%, #FFFFFF 0% 50%) 50% / 8px 8px;
}

.canvas-preview-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-md);
  margin-top: var(--spacing-md);
}

#canvasPreview {
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
}

.canvas-info {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

/* ===== í…œí”Œë¦¿ ì—ë””í„° ===== */
.template-editor-body {
  max-height: 70vh;
  overflow-y: auto;
}

.editor-section {
  margin-bottom: var(--spacing-lg);
  padding-bottom: var(--spacing-lg);
  border-bottom: 1px solid var(--color-border);
}

.editor-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.editor-section h3 {
  font-size: var(--font-size-base);
  font-weight: 600;
  margin-bottom: var(--spacing-md);
}

.editor-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
}

.template-fields-editor {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.editor-field-item {
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  overflow: hidden;
}

.editor-field-header {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-bg-tertiary);
  border-bottom: 1px solid var(--color-border);
}

.field-drag-handle {
  cursor: move;
  color: var(--color-text-muted);
  font-size: var(--font-size-sm);
}

.field-type-badge {
  background: var(--color-accent);
  color: white;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
}

.field-label-preview {
  font-family: monospace;
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
}

.field-actions {
  margin-left: auto;
  display: flex;
  gap: var(--spacing-xs);
}

.editor-field-body {
  padding: var(--spacing-md);
}

.field-row {
  display: flex;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-sm);
}

.field-col {
  flex: 1;
}

.field-col-sm {
  max-width: 60px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.field-col label {
  display: block;
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-xs);
}

.field-options {
  background: var(--color-bg-tertiary);
  padding: var(--spacing-sm);
  border-radius: var(--radius-sm);
  margin-top: var(--spacing-sm);
}

.option-row {
  display: flex;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-xs);
}

.option-row .form-input {
  flex: 1;
}

.empty-fields-message {
  text-align: center;
  padding: var(--spacing-xl);
  color: var(--color-text-muted);
}

.field-placeholders {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-sm);
}

.field-placeholder-btn {
  padding: var(--spacing-xs) var(--spacing-sm);
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-family: monospace;
  cursor: pointer;
}

.field-placeholder-btn:hover {
  background: var(--color-primary-light);
  border-color: var(--color-primary);
}

.custom-template-actions {
  display: flex;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-md);
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--color-border);
  flex-wrap: wrap;
}

.template-duplicate-btn {
  margin-bottom: var(--spacing-md);
}


/* ===== editing.css ===== */
/* ===== Thinking ëª¨ë“œ í† ê¸€ ===== */
.thinking-toggle {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-bg-primary);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.thinking-toggle:hover {
  border-color: var(--color-accent);
}

.thinking-toggle.active {
  background: rgba(108, 92, 231, 0.1);
  border-color: var(--color-accent);
}

.thinking-toggle input {
  display: none;
}

.thinking-toggle-switch {
  width: 40px;
  height: 20px;
  background: var(--color-border);
  border-radius: 10px;
  position: relative;
  transition: background 0.2s ease;
}

.thinking-toggle.active .thinking-toggle-switch {
  background: var(--color-accent);
}

.thinking-toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s ease;
}

.thinking-toggle.active .thinking-toggle-switch::after {
  transform: translateX(20px);
}

.thinking-toggle-label {
  font-size: var(--font-size-sm);
  font-weight: 500;
  color: var(--color-text-secondary);
}

.thinking-toggle.active .thinking-toggle-label {
  color: var(--color-accent);
}

.thinking-tooltip {
  position: relative;
}

.thinking-tooltip .tooltip-content {
  position: absolute;
  top: 100%;
  right: 0;
  width: 280px;
  background: var(--color-secondary);
  color: white;
  padding: var(--spacing-md);
  border-radius: var(--radius-md);
  font-size: var(--font-size-xs);
  line-height: 1.5;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(8px);
  transition: all 0.2s ease;
  box-shadow: var(--shadow-lg);
}

.thinking-tooltip:hover .tooltip-content {
  opacity: 1;
  visibility: visible;
  transform: translateY(4px);
}

/* ===== í¸ì§‘ ì„¸ì…˜ UI ===== */
.edit-session {
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-md);
}

.edit-session-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.edit-session-title {
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: var(--color-text-primary);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.edit-session-actions {
  display: flex;
  gap: var(--spacing-xs);
}

/* í¸ì§‘ íˆìŠ¤í† ë¦¬ */
.edit-history {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-md);
  max-height: 200px;
  overflow-y: auto;
}

.edit-history-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm);
  background: var(--color-bg-primary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.edit-history-item:hover {
  border-color: var(--color-accent);
}

.edit-history-item.active {
  border-color: var(--color-accent);
  background: rgba(108, 92, 231, 0.05);
}

.edit-history-item .step-number {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--color-accent);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-size-xs);
  font-weight: 600;
  flex-shrink: 0;
}

.edit-history-item.pending .step-number {
  background: var(--color-border);
}

.edit-history-item .step-content {
  flex: 1;
  overflow: hidden;
}

.edit-history-item .step-label {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
}

.edit-history-item .step-text {
  font-size: var(--font-size-sm);
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.edit-history-item .step-thumb {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  flex-shrink: 0;
}

.edit-history-item .step-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ìˆ˜ì • ìš”ì²­ ì…ë ¥ */
.edit-request {
  margin-top: var(--spacing-sm);
}

.edit-request-input {
  width: 100%;
  padding: var(--spacing-sm);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-family: inherit;
  font-size: var(--font-size-sm);
  resize: none;
  min-height: 60px;
}

.edit-request-input:focus {
  outline: none;
  border-color: var(--color-accent);
  box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
}

.edit-request-actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-sm);
}

/* ===== ë¹ ë¥¸ ìˆ˜ì • í”„ë¦¬ì…‹ ===== */
.quick-presets {
  margin-top: var(--spacing-md);
  padding-top: var(--spacing-md);
  border-top: 1px solid var(--color-border);
}

.quick-presets-title {
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-sm);
}

.preset-categories {
  display: flex;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-sm);
  flex-wrap: wrap;
}

.preset-category-btn {
  padding: var(--spacing-xs) var(--spacing-sm);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  background: var(--color-bg-primary);
  font-size: var(--font-size-xs);
  cursor: pointer;
  transition: all 0.2s ease;
}

.preset-category-btn:hover {
  border-color: var(--color-accent);
}

.preset-category-btn.active {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-accent);
}

.preset-items {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
}

.preset-item {
  padding: var(--spacing-xs) var(--spacing-sm);
  background: var(--color-bg-tertiary);
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  cursor: pointer;
  transition: all 0.2s ease;
}

.preset-item:hover {
  background: var(--color-primary-light);
  border-color: var(--color-primary);
}


/* ===== responsive.css ===== */
/* ===== ë°˜ì‘í˜• ===== */
@media (max-width: 1200px) {
  .main-3col {
    grid-template-columns: 1fr 1fr;
  }
  .main-3col > .panel:first-child {
    grid-column: 1 / -1;
  }
}

@media (max-width: 1024px) {
  .main {
    grid-template-columns: 1fr;
  }
  .main-3col {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    gap: var(--spacing-md);
    text-align: center;
  }

  .header-actions {
    width: 100%;
    justify-content: center;
  }

  .main {
    padding: var(--spacing-md);
  }

  .main-3col {
    padding: var(--spacing-md);
  }

  .template-tabs {
    justify-content: center;
  }

  .action-bar {
    flex-direction: column;
  }

  .work-mode-bar {
    flex-wrap: wrap;
    justify-content: center;
  }

  .translate-toggle {
    margin-left: 0;
    width: 100%;
    justify-content: center;
    margin-top: var(--spacing-sm);
  }
}


/* ===== utilities.css ===== */
/* ===== ìœ í‹¸ë¦¬í‹° ===== */
.hidden {
  display: none !important;
}

.text-center {
  text-align: center;
}

.mt-md {
  margin-top: var(--spacing-md);
}

.mb-md {
  margin-bottom: var(--spacing-md);
}

  </style>
</head>
<body>
<div id="app">
    <!-- í—¤ë” -->
    <header class="header">
      <h1 class="header-title">
        <span>ğŸŒ</span>
        <span>ë‚˜ë…¸ ë°”ë‚˜ë‚˜ í”„ë¡¬í”„íŠ¸ ì–´ì‹œìŠ¤í„´íŠ¸</span>
      </h1>
      <div class="header-actions">
        <!-- Thinking ëª¨ë“œ í† ê¸€ -->
        <div class="thinking-tooltip">
          <label id="thinkingToggle" class="thinking-toggle" onclick="toggleThinkingMode()">
            <input type="checkbox" id="thinkingCheckbox">
            <span class="thinking-toggle-switch"></span>
            <span class="thinking-toggle-label">ğŸ§  Thinking</span>
          </label>
          <div class="tooltip-content">
            <strong>Thinking ëª¨ë“œ</strong><br>
            AIê°€ ì´ë¯¸ì§€ ìƒì„± ì „ ë…¼ë¦¬ì  ê²€í† ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.<br><br>
            <strong>ê¶Œì¥ ìƒí™©:</strong><br>
            â€¢ ë‹¤ì¤‘ ìš”ì†Œê°€ ìˆëŠ” ë³µì¡í•œ ì¥ë©´<br>
            â€¢ ì •í™•í•œ í…ìŠ¤íŠ¸ ë Œë”ë§<br>
            â€¢ ë¬¼ë¦¬ì  ì •í™•ì„±ì´ ì¤‘ìš”í•œ ì´ë¯¸ì§€<br>
            â€¢ ì—¬ëŸ¬ ì´ë¯¸ì§€ì˜ ì¼ê´€ì„± ìœ ì§€
          </div>
        </div>
        <div id="apiStatus" class="api-status disconnected">
          <span class="status-dot"></span>
          <span id="apiStatusText">API ë¯¸ì—°ê²°</span>
        </div>
        <button class="btn btn-secondary" onclick="openSettingsModal()">
          <span>âš™ï¸</span>
          <span>API ì„¤ì •</span>
        </button>
      </div>
    </header>

    <!-- ì‘ì—… ëª¨ë“œ ë°” -->
    <div class="work-mode-bar">
      <span class="work-mode-label">ì‘ì—… ëª¨ë“œ:</span>
      <div class="work-mode-buttons" id="workModeButtons">
        <button class="work-mode-btn active" data-mode="explore" onclick="setWorkMode('explore')">
          <span class="mode-icon">ğŸ”</span>
          <span class="mode-name">íƒìƒ‰</span>
          <span class="mode-size">512px</span>
        </button>
        <button class="work-mode-btn" data-mode="refine" onclick="setWorkMode('refine')">
          <span class="mode-icon">âœ¨</span>
          <span class="mode-name">ì •ì œ</span>
          <span class="mode-size">1024px</span>
        </button>
        <button class="work-mode-btn" data-mode="final" onclick="setWorkMode('final')">
          <span class="mode-icon">ğŸ“¸</span>
          <span class="mode-name">ìµœì¢…</span>
          <span class="mode-size">ì›ë³¸</span>
        </button>
      </div>
      <label class="translate-toggle">
        <input type="checkbox" id="translateToggle" onchange="handleTranslateToggle(this.checked)">
        <span>ğŸŒ í•œê¸€â†’ì˜ì–´ ìë™ ë²ˆì—­</span>
      </label>
    </div>

    <!-- ë©”ì¸ (3ì—´ ë ˆì´ì•„ì›ƒ) -->
    <main class="main-3col">
      <!-- ì²¨ë¶€ ì´ë¯¸ì§€ íŒ¨ë„ -->
      <div class="panel">
        <div class="panel-header">
          <span>ğŸ“</span>
          <span>ì²¨ë¶€ ì´ë¯¸ì§€</span>
          <span style="margin-left: auto; font-size: var(--font-size-xs); color: var(--color-text-muted);">
            (<span id="attachedCount">0</span>/14)
          </span>
        </div>
        <div class="panel-body">
          <!-- ì—…ë¡œë“œ ì˜ì—­ -->
          <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-area-icon">ğŸ“¤</div>
            <div class="upload-area-text">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜<br>í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
            <div class="upload-area-hint">PNG, JPG, WEBP (ìµœëŒ€ 14ê°œ)</div>
          </div>
          <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(event)">

          <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ -->
          <div class="thumbnail-grid" id="thumbnailGrid">
            <!-- JavaScriptë¡œ ë Œë”ë§ -->
          </div>

          <!-- ì„ íƒëœ ì´ë¯¸ì§€ ì •ë³´ -->
          <div class="selected-image-info hidden" id="selectedImageInfo">
            <img class="selected-image-preview" id="selectedImagePreview" src="" alt="ì„ íƒëœ ì´ë¯¸ì§€">
            <div class="selected-image-meta" id="selectedImageMeta">
              <!-- JavaScriptë¡œ ë Œë”ë§ -->
            </div>
            <div class="selected-image-actions">
              <button class="btn btn-outline btn-sm" onclick="viewOriginalImage()">ğŸ” ì›ë³¸ ë³´ê¸°</button>
              <button class="btn btn-outline btn-sm" onclick="deleteSelectedImage()">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
          </div>

          <!-- ë¹ˆ ìº”ë²„ìŠ¤ ìƒì„± ë²„íŠ¼ -->
          <div class="canvas-generator-btn-container">
            <button class="btn btn-outline" onclick="openCanvasGenerator()">
              ğŸ“ ë¹ˆ ìº”ë²„ìŠ¤ ìƒì„±
            </button>
          </div>
        </div>
      </div>

      <!-- í”„ë¡¬í”„íŠ¸ ë¹Œë” íŒ¨ë„ -->
      <div class="panel">
        <!-- í…œí”Œë¦¿ íƒ­ -->
        <div class="template-tabs" id="templateTabs">
          <!-- JavaScriptë¡œ ë Œë”ë§ -->
        </div>

        <!-- í¼ ì˜ì—­ -->
        <div class="panel-body">
          <div id="templateForm">
            <!-- JavaScriptë¡œ ë Œë”ë§ -->
          </div>

          <!-- í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
          <div class="prompt-preview">
            <div class="prompt-preview-header">
              <span class="prompt-preview-title">ğŸ“ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</span>
              <div class="prompt-tabs" id="promptTabs">
                <button class="prompt-tab active" data-tab="original" onclick="setPromptTab('original')">ì›ë³¸</button>
                <button class="prompt-tab" data-tab="translated" onclick="setPromptTab('translated')">ë²ˆì—­</button>
              </div>
              <button class="btn btn-outline btn-icon" onclick="openPromptHistory()" title="íˆìŠ¤í† ë¦¬">
                ğŸ“œ
              </button>
              <button class="btn btn-outline btn-icon" onclick="copyPrompt()" title="ë³µì‚¬">
                ğŸ“‹
              </button>
            </div>
            <div id="promptPreview" class="prompt-preview-text empty">
              í•„ë“œë¥¼ ì…ë ¥í•˜ë©´ í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.
            </div>
            <div id="translateStatus" class="translate-status hidden">
              <span id="translateStatusText"></span>
            </div>
          </div>

          <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
          <div id="errorMessage" class="error-message hidden"></div>

          <!-- ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="action-bar">
            <button class="btn btn-outline" onclick="resetForm()">
              ğŸ”„ ì´ˆê¸°í™”
            </button>
            <button class="btn btn-accent btn-lg" onclick="generateImage()" id="generateBtn">
              ğŸ¨ ì´ë¯¸ì§€ ìƒì„±
            </button>
          </div>
        </div>
      </div>

      <!-- ê²°ê³¼ íŒ¨ë„ -->
      <div class="panel">
        <div class="panel-header">
          <span>ğŸ–¼ï¸</span>
          <span>ìƒì„± ê²°ê³¼</span>
        </div>
        <div class="panel-body">
          <!-- í¸ì§‘ ì„¸ì…˜ UI -->
          <div class="edit-session hidden" id="editSession">
            <div class="edit-session-header">
              <div class="edit-session-title">
                <span>ğŸ”„</span>
                <span>í¸ì§‘ ì„¸ì…˜</span>
              </div>
              <div class="edit-session-actions">
                <button class="btn btn-outline btn-icon" onclick="saveEditSession()" title="ì„¸ì…˜ ì €ì¥">ğŸ’¾</button>
                <button class="btn btn-outline btn-icon" onclick="loadEditSession()" title="ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚</button>
                <button class="btn btn-outline btn-icon" onclick="startNewSession()" title="ìƒˆ ì„¸ì…˜">ğŸ”„</button>
              </div>
            </div>

            <!-- í¸ì§‘ íˆìŠ¤í† ë¦¬ -->
            <div class="edit-history" id="editHistory">
              <!-- JavaScriptë¡œ ë Œë”ë§ -->
            </div>

            <!-- ìˆ˜ì • ìš”ì²­ ì…ë ¥ -->
            <div class="edit-request">
              <textarea
                class="edit-request-input"
                id="editRequestInput"
                placeholder="ì´ì „ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
              ></textarea>
              <div class="edit-request-actions">
                <button class="btn btn-outline" onclick="clearEditRequest()">ì§€ìš°ê¸°</button>
                <button class="btn btn-accent" onclick="applyEditRequest()" id="applyEditBtn">âœ¨ ìˆ˜ì • ì ìš©</button>
              </div>
            </div>

            <!-- ë¹ ë¥¸ ìˆ˜ì • í”„ë¦¬ì…‹ -->
            <div class="quick-presets">
              <div class="quick-presets-title">âš¡ ë¹ ë¥¸ ìˆ˜ì •</div>
              <div class="preset-categories" id="presetCategories">
                <!-- JavaScriptë¡œ ë Œë”ë§ -->
              </div>
              <div class="preset-items" id="presetItems">
                <!-- JavaScriptë¡œ ë Œë”ë§ -->
              </div>
            </div>
          </div>

          <!-- íˆìŠ¤í† ë¦¬ ì¸ë„¤ì¼ -->
          <div class="result-history hidden" id="resultHistory">
            <!-- JavaScriptë¡œ ë Œë”ë§ -->
          </div>

          <div id="resultContainer" class="result-container">
            <div class="result-placeholder">
              <div class="result-placeholder-icon">ğŸ¨</div>
              <div>í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê³ <br>ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="imageModal" class="image-modal-overlay">
      <div class="image-modal-content">
        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
        <button class="image-modal-nav prev" onclick="navigateImageModal(-1)">â—€</button>
        <img class="image-modal-img" id="imageModalImg" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
        <button class="image-modal-nav next" onclick="navigateImageModal(1)">â–¶</button>
        <div class="image-modal-actions">
          <button class="btn btn-primary" onclick="downloadModalImage()">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-secondary" onclick="reusePrompt()">âœï¸ ì¬í¸ì§‘</button>
        </div>
        <div class="image-modal-info" id="imageModalInfo"></div>
      </div>
    </div>

    <!-- API ì„¤ì • ëª¨ë‹¬ -->
    <div id="settingsModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">âš™ï¸ API ì„¤ì •</h2>
          <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Gemini API Key</label>
            <div class="input-group">
              <input
                type="password"
                id="apiKeyInput"
                class="form-input"
                placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
              >
              <button class="btn btn-outline btn-icon" onclick="toggleApiKeyVisibility()" title="ë³´ê¸°/ìˆ¨ê¸°ê¸°">
                ğŸ‘
              </button>
            </div>
            <p class="form-help">
              API í‚¤ëŠ” ë¸Œë¼ìš°ì € ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë©ë‹ˆë‹¤.
              <a href="https://aistudio.google.com/app/apikey" target="_blank">API í‚¤ ë°œê¸‰ë°›ê¸°</a>
            </p>
          </div>

          <div id="apiTestResult"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="testApiConnection()" id="testApiBtn">
            ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
          <button class="btn btn-primary" onclick="saveApiKey()">
            ğŸ’¾ ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
    <div id="promptHistoryModal" class="modal-overlay">
      <div class="modal modal-lg">
        <div class="modal-header">
          <h2 class="modal-title">ğŸ“œ í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬</h2>
          <button class="modal-close" onclick="closePromptHistory()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="history-search">
            <input type="text" id="promptHistorySearch" class="form-input"
                   placeholder="í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰..."
                   oninput="searchPromptHistory(this.value)">
          </div>
          <div id="promptHistoryList" class="prompt-history-list">
            <!-- JavaScriptë¡œ ë Œë”ë§ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline btn-danger" onclick="clearAllPromptHistory()">
            ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
          </button>
          <button class="btn btn-outline" onclick="closePromptHistory()">ë‹«ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ìº”ë²„ìŠ¤ ìƒì„±ê¸° ëª¨ë‹¬ -->
    <div id="canvasGeneratorModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">ğŸ“ ë¹ˆ ìº”ë²„ìŠ¤ ìƒì„±</h2>
          <button class="modal-close" onclick="closeCanvasGenerator()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ì¢…íš¡ë¹„ ì„ íƒ</label>
            <div id="aspectRatioButtons" class="aspect-ratio-grid">
              <!-- JavaScriptë¡œ ë Œë”ë§ -->
            </div>
          </div>

          <div class="form-group canvas-size-inputs">
            <label class="form-label">í¬ê¸°</label>
            <div class="size-input-row">
              <div class="size-input-group">
                <label>ë„ˆë¹„</label>
                <input type="number" id="canvasWidth" class="form-input"
                       value="1024" min="100" max="4096"
                       onchange="setCanvasCustomSize(this.value, document.getElementById('canvasHeight').value)">
              </div>
              <span class="size-separator">Ã—</span>
              <div class="size-input-group">
                <label>ë†’ì´</label>
                <input type="number" id="canvasHeight" class="form-input"
                       value="1024" min="100" max="4096"
                       onchange="setCanvasCustomSize(document.getElementById('canvasWidth').value, this.value)">
              </div>
              <span class="size-unit">px</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ê¸°ì¤€ í¬ê¸° (ê¸´ ìª½)</label>
            <select id="canvasBaseSize" class="form-select" onchange="setCanvasBaseSize(this.value)">
              <option value="512">512px</option>
              <option value="768">768px</option>
              <option value="1024" selected>1024px</option>
              <option value="1536">1536px</option>
              <option value="2048">2048px</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">ë°°ê²½ìƒ‰</label>
            <div class="background-options">
              <label class="background-option">
                <input type="radio" name="bgType" value="white" checked
                       onchange="setCanvasBackgroundType('white')">
                <span class="bg-preview bg-white"></span>
                <span>í°ìƒ‰</span>
              </label>
              <label class="background-option">
                <input type="radio" name="bgType" value="transparent"
                       onchange="setCanvasBackgroundType('transparent')">
                <span class="bg-preview bg-transparent"></span>
                <span>íˆ¬ëª…</span>
              </label>
              <label class="background-option">
                <input type="radio" name="bgType" value="custom"
                       onchange="setCanvasBackgroundType('custom')">
                <input type="color" id="canvasBgColor" value="#FFFFFF"
                       onchange="setCanvasBackgroundColor(this.value)">
                <span>ì»¤ìŠ¤í…€</span>
              </label>
            </div>
          </div>

          <div class="canvas-preview-container">
            <canvas id="canvasPreview" width="200" height="200"></canvas>
            <div id="canvasInfo" class="canvas-info">1024 Ã— 1024px</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeCanvasGenerator()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="generateAndAttachCanvas()">
            âœ… ìº”ë²„ìŠ¤ ìƒì„± ë° ì²¨ë¶€
          </button>
        </div>
      </div>
    </div>

    <!-- í…œí”Œë¦¿ ì—ë””í„° ëª¨ë‹¬ -->
    <div id="templateEditorModal" class="modal-overlay">
      <div class="modal modal-xl">
        <div class="modal-header">
          <h2 class="modal-title">ğŸ“ í…œí”Œë¦¿ í¸ì§‘ê¸°</h2>
          <button class="modal-close" onclick="closeTemplateEditor()">&times;</button>
        </div>
        <div class="modal-body template-editor-body">
          <div class="editor-section">
            <h3>ê¸°ë³¸ ì •ë³´</h3>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">í…œí”Œë¦¿ ì´ë¦„ <span class="required">*</span></label>
                <input type="text" id="templateName" class="form-input" placeholder="ì˜ˆ: ë‚´ ì œí’ˆ ì‚¬ì§„ í…œí”Œë¦¿">
              </div>
              <div class="form-group form-group-sm">
                <label class="form-label">ì•„ì´ì½˜</label>
                <input type="text" id="templateIcon" class="form-input" value="ğŸ¨" maxlength="2">
              </div>
              <div class="form-group">
                <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select id="templateCategory" class="form-select">
                  <option value="custom">ì»¤ìŠ¤í…€</option>
                  <option value="basic">ê¸°ë³¸</option>
                  <option value="typography">íƒ€ì´í¬ê·¸ë˜í”¼</option>
                  <option value="artwork">ì•„íŠ¸ì›Œí¬</option>
                  <option value="professional">ì „ë¬¸</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ì„¤ëª…</label>
              <input type="text" id="templateDescription" class="form-input" placeholder="í…œí”Œë¦¿ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…">
            </div>
          </div>

          <div class="editor-section">
            <div class="editor-section-header">
              <h3>í•„ë“œ</h3>
              <button class="btn btn-primary btn-sm" onclick="addEditorField()">â• í•„ë“œ ì¶”ê°€</button>
            </div>
            <div id="templateFieldsEditor" class="template-fields-editor">
              <div class="empty-fields-message">í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. "í•„ë“œ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
            </div>
          </div>

          <div class="editor-section">
            <h3>í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</h3>
            <p class="form-help">í•„ë“œ ê°’ì„ ì‚½ì…í•˜ë ¤ë©´ {í•„ë“œID}ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ ì‚½ì…ë©ë‹ˆë‹¤.</p>
            <div class="field-placeholders" id="fieldPlaceholders">
              <!-- JavaScriptë¡œ í•„ë“œ ë²„íŠ¼ ë Œë”ë§ -->
            </div>
            <textarea id="templatePrompt" class="form-textarea" rows="6"
                      placeholder="Create a {style} image of {subject}..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="importTemplate()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
          <button class="btn btn-outline" onclick="closeTemplateEditor()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="saveTemplate()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ES Module ì§„ì…ì  -->

  <script>
// ===== ë‚˜ë…¸ ë°”ë‚˜ë‚˜ í”„ë¡¬í”„íŠ¸ ì–´ì‹œìŠ¤í„´íŠ¸ =====
// ë¹Œë“œ: 2025-12-24T00:24:59.358Z
(function() {
  'use strict';

// ===== templates.js =====
// ===== TEMPLATES =====

const TEMPLATES = {
  basic: {
    id: 'basic',
    name: 'ê¸°ë³¸ í”„ë¡¬í”„íŠ¸',
    icon: 'ğŸ¨',
    category: 'basic',
    description: 'Google ê³µì‹ 6ìš”ì†Œ ê³µì‹ ê¸°ë°˜',
    fields: [
      {
        id: 'subject',
        label: 'ì£¼ì œ (Subject)',
        type: 'textarea',
        placeholder: 'ì˜ˆ: íŒŒë€ìƒ‰ ë°œê´‘ ê´‘í•™ê¸°ë¥¼ ê°€ì§„ ê¸ˆìš•ì ì¸ ë¡œë´‡ ë°”ë¦¬ìŠ¤íƒ€',
        required: true,
        helpText: 'êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. "ë¡œë´‡"ë³´ë‹¤ "íŒŒë€ ë°œê´‘ ê´‘í•™ê¸°ë¥¼ ê°€ì§„ ë¡œë´‡ ë°”ë¦¬ìŠ¤íƒ€"ê°€ ì¢‹ìŠµë‹ˆë‹¤.'
      },
      {
        id: 'composition',
        label: 'êµ¬ì„± (Composition)',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'extreme close-up', label: 'ìµìŠ¤íŠ¸ë¦¼ í´ë¡œì¦ˆì—…' },
          { value: 'close-up', label: 'í´ë¡œì¦ˆì—…' },
          { value: 'medium shot', label: 'ë¯¸ë””ì—„ ìƒ·' },
          { value: 'wide shot', label: 'ì™€ì´ë“œ ìƒ·' },
          { value: 'establishing shot', label: 'ì „ì²´ ìƒ·' },
          { value: 'birds eye view', label: 'ë²„ë“œ ì•„ì´ ë·°' },
          { value: 'worms eye view', label: 'ì›œì¦ˆ ì•„ì´ ë·°' }
        ]
      },
      {
        id: 'action',
        label: 'ì•¡ì…˜ (Action)',
        type: 'text',
        placeholder: 'ì˜ˆ: ì»¤í”¼ë¥¼ ë‚´ë¦¬ê³  ìˆëŠ”, ë‹¬ë¦¬ëŠ” ì¤‘ì¸'
      },
      {
        id: 'location',
        label: 'ìœ„ì¹˜ (Location)',
        type: 'text',
        placeholder: 'ì˜ˆ: í™”ì„±ì˜ ë¯¸ë˜í˜• ì¹´í˜ì—ì„œ'
      },
      {
        id: 'style',
        label: 'ìŠ¤íƒ€ì¼ (Style)',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'photorealistic', label: 'í¬í† ë¦¬ì–¼ë¦¬ìŠ¤í‹±' },
          { value: '3D animation', label: '3D ì• ë‹ˆë©”ì´ì…˜' },
          { value: 'watercolor painting', label: 'ìˆ˜ì±„í™”' },
          { value: 'oil painting', label: 'ìœ í™”' },
          { value: 'pencil sketch', label: 'ì—°í•„ ìŠ¤ì¼€ì¹˜' },
          { value: 'digital art', label: 'ë””ì§€í„¸ ì•„íŠ¸' },
          { value: 'vintage photograph', label: 'ë¹ˆí‹°ì§€ ì‚¬ì§„' }
        ]
      },
      {
        id: 'lighting',
        label: 'ì¡°ëª…',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'golden hour sunlight', label: 'ê³¨ë“ ì•„ì›Œ' },
          { value: 'soft diffused light', label: 'ì†Œí”„íŠ¸ ë””í“¨ì¦ˆë“œ' },
          { value: 'dramatic chiaroscuro', label: 'ëª…ì•”ë²• (Chiaroscuro)' },
          { value: 'neon lighting', label: 'ë„¤ì˜¨ ì¡°ëª…' },
          { value: 'studio three-point lighting', label: 'ìŠ¤íŠœë””ì˜¤ 3ì  ì¡°ëª…' },
          { value: 'Rembrandt lighting', label: 'ë ˜ë¸Œë€íŠ¸ ì¡°ëª…' }
        ]
      },
      {
        id: 'additional',
        label: 'ì¶”ê°€ ì§€ì‹œì‚¬í•­',
        type: 'textarea',
        placeholder: 'ìƒ‰ìƒ íŒ”ë ˆíŠ¸, ë¶„ìœ„ê¸°, ê¸°íƒ€ ì„¸ë¶€ì‚¬í•­...'
      }
    ],
    promptTemplate: 'Create a {style} image of {subject}{action}{location}. {composition}. {lighting}. {additional}'
  },

  photo: {
    id: 'photo',
    name: 'í¬í† ë¦¬ì–¼ë¦¬ìŠ¤í‹±',
    icon: 'ğŸ“·',
    category: 'basic',
    description: 'ì‚¬ì§„ ìŠ¤íƒ€ì¼ ì´ë¯¸ì§€ ìƒì„±',
    fields: [
      {
        id: 'subject',
        label: 'í”¼ì‚¬ì²´',
        type: 'textarea',
        placeholder: 'ì˜ˆ: ì„ì–‘ì„ ë°”ë¼ë³´ëŠ” ì Šì€ ì—¬ì„±',
        required: true
      },
      {
        id: 'camera',
        label: 'ì¹´ë©”ë¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'Canon EOS R5', label: 'Canon EOS R5' },
          { value: 'Sony A7R V', label: 'Sony A7R V' },
          { value: 'Nikon Z9', label: 'Nikon Z9' },
          { value: 'Hasselblad H6D', label: 'Hasselblad H6D' }
        ]
      },
      {
        id: 'lens',
        label: 'ë Œì¦ˆ',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: '85mm f/1.4', label: '85mm f/1.4 (ì¸ë¬¼)' },
          { value: '35mm f/1.4', label: '35mm f/1.4 (í™˜ê²½ ì¸ë¬¼)' },
          { value: '24-70mm f/2.8', label: '24-70mm f/2.8 (ë²”ìš©)' },
          { value: '70-200mm f/2.8', label: '70-200mm f/2.8 (ë§ì›)' },
          { value: '100mm macro', label: '100mm ë§¤í¬ë¡œ' }
        ]
      },
      {
        id: 'aperture',
        label: 'ì¡°ë¦¬ê°œ',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'f/1.4', label: 'f/1.4 (ê·¹ì–•ì€ ì‹¬ë„)' },
          { value: 'f/2.8', label: 'f/2.8 (ì–•ì€ ì‹¬ë„)' },
          { value: 'f/5.6', label: 'f/5.6 (ì¤‘ê°„)' },
          { value: 'f/8', label: 'f/8 (ì„ ëª…)' },
          { value: 'f/11', label: 'f/11 (í’ê²½)' }
        ]
      },
      {
        id: 'lighting',
        label: 'ì¡°ëª…',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'golden hour sunlight', label: 'ê³¨ë“ ì•„ì›Œ' },
          { value: 'soft window light', label: 'ì°½ë¬¸ ìì—°ê´‘' },
          { value: 'overcast diffused', label: 'íë¦° ë‚  í™•ì‚°ê´‘' },
          { value: 'Rembrandt lighting', label: 'ë ˜ë¸Œë€íŠ¸ ì¡°ëª…' },
          { value: 'rim light', label: 'ë¦¼ ë¼ì´íŠ¸' },
          { value: 'three-point studio', label: '3ì  ìŠ¤íŠœë””ì˜¤ ì¡°ëª…' }
        ]
      },
      {
        id: 'filmStock',
        label: 'í•„ë¦„/ìƒ‰ê°',
        type: 'select',
        options: [
          { value: '', label: 'ê¸°ë³¸ ë””ì§€í„¸' },
          { value: 'Kodachrome 64 color science', label: 'Kodachrome 64' },
          { value: 'Fujifilm Velvia saturated', label: 'Fujifilm Velvia' },
          { value: 'Cinestill 800T', label: 'Cinestill 800T' },
          { value: 'vintage Polaroid', label: 'ë¹ˆí‹°ì§€ í´ë¼ë¡œì´ë“œ' }
        ]
      },
      {
        id: 'depthOfField',
        label: 'í”¼ì‚¬ê³„ ì‹¬ë„',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'shallow depth of field with creamy bokeh', label: 'ì–•ì€ ì‹¬ë„, í¬ë¦¬ë¯¸ ë³´ì¼€' },
          { value: 'sharp focus throughout', label: 'ì „ì²´ ì„ ëª…' },
          { value: 'selective focus on subject', label: 'í”¼ì‚¬ì²´ë§Œ ì„ ëª…' }
        ]
      },
      {
        id: 'additional',
        label: 'ì¶”ê°€ ì§€ì‹œì‚¬í•­',
        type: 'textarea',
        placeholder: 'ë¶„ìœ„ê¸°, ìƒ‰ì¡°, ê¸°íƒ€ ì„¸ë¶€ì‚¬í•­...'
      }
    ],
    promptTemplate: 'A photorealistic photograph of {subject}. Captured with {camera}, {lens} lens at {aperture}. {lighting}. {filmStock}. {depthOfField}. {additional}'
  },

  typography: {
    id: 'typography',
    name: 'íƒ€ì´í¬ê·¸ë˜í”¼',
    icon: 'âœï¸',
    category: 'typography',
    description: 'í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ ì´ë¯¸ì§€ ìƒì„±',
    fields: [
      {
        id: 'text',
        label: 'í‘œì‹œí•  í…ìŠ¤íŠ¸',
        type: 'text',
        placeholder: 'ì˜ˆ: HELLO WORLD',
        required: true,
        helpText: '25ì ì´í•˜ ê¶Œì¥, 2-3ê°œ ë¬¸êµ¬ë¡œ ì œí•œí•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤.'
      },
      {
        id: 'fontStyle',
        label: 'í°íŠ¸ ìŠ¤íƒ€ì¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'bold sans-serif', label: 'êµµì€ ì‚°ì„¸ë¦¬í”„' },
          { value: 'elegant serif', label: 'ìš°ì•„í•œ ì„¸ë¦¬í”„' },
          { value: 'hand-written script', label: 'ì†ê¸€ì”¨ í•„ê¸°ì²´' },
          { value: 'retro vintage', label: 'ë ˆíŠ¸ë¡œ ë¹ˆí‹°ì§€' },
          { value: 'modern minimalist', label: 'ëª¨ë˜ ë¯¸ë‹ˆë©€ë¦¬ìŠ¤íŠ¸' },
          { value: 'graffiti style', label: 'ê·¸ë˜í”¼í‹° ìŠ¤íƒ€ì¼' },
          { value: 'neon sign', label: 'ë„¤ì˜¨ ì‚¬ì¸' }
        ]
      },
      {
        id: 'textColor',
        label: 'í…ìŠ¤íŠ¸ ìƒ‰ìƒ',
        type: 'text',
        placeholder: 'ì˜ˆ: í°ìƒ‰, ê¸ˆìƒ‰, ê·¸ë¼ë°ì´ì…˜ íŒŒë‘-ë³´ë¼'
      },
      {
        id: 'placement',
        label: 'í…ìŠ¤íŠ¸ ìœ„ì¹˜',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'centered in the image', label: 'ì¤‘ì•™' },
          { value: 'at the top', label: 'ìƒë‹¨' },
          { value: 'at the bottom', label: 'í•˜ë‹¨' },
          { value: 'diagonal across', label: 'ëŒ€ê°ì„ ' },
          { value: 'curved around subject', label: 'ê³¡ì„ ìœ¼ë¡œ ë°°ì¹˜' }
        ]
      },
      {
        id: 'background',
        label: 'ë°°ê²½',
        type: 'text',
        placeholder: 'ì˜ˆ: ì–´ë‘ìš´ ìš°ì£¼ ë°°ê²½, í°ìƒ‰ ëŒ€ë¦¬ì„, ë„¤ì˜¨ ë„ì‹œ'
      },
      {
        id: 'effects',
        label: 'íš¨ê³¼',
        type: 'text',
        placeholder: 'ì˜ˆ: ê·¸ë¦¼ì, ë¹› ë°œì‚°, 3D ì…ì²´ê°'
      },
      {
        id: 'additional',
        label: 'ì¶”ê°€ ì§€ì‹œì‚¬í•­',
        type: 'textarea',
        placeholder: 'ê¸°íƒ€ ì„¸ë¶€ì‚¬í•­...'
      }
    ],
    promptTemplate: 'Create an image with the text "{text}" displayed prominently. Font style: {fontStyle}. Text color: {textColor}. Text placement: {placement}. Background: {background}. Effects: {effects}. {additional}'
  },

  logoGrid: {
    id: 'logoGrid',
    name: '8ê°œ ë¡œê³  ê·¸ë¦¬ë“œ',
    icon: 'ğŸ”¤',
    category: 'typography',
    description: 'í•œ ë²ˆì— ì—¬ëŸ¬ ë¡œê³  ë³€í˜• ìƒì„±',
    fields: [
      {
        id: 'theme',
        label: 'í…Œë§ˆ',
        type: 'text',
        placeholder: 'ì˜ˆ: ìŒì‹, ê°ì •, ë™ë¬¼',
        required: true
      },
      {
        id: 'expressionStyle',
        label: 'í‘œí˜„ ë°©ì‹',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'letters visually express meaning', label: 'ê¸€ìê°€ ì˜ë¯¸ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„' },
          { value: 'letters made of actual objects', label: 'ê¸€ìë¥¼ ì‹¤ì œ ë¬¼ì²´ë¡œ ì œì‘' },
          { value: 'letters with dramatic shadows', label: 'ê·¹ì ì¸ ê·¸ë¦¼ìê°€ ìˆëŠ” ê¸€ì' }
        ]
      },
      {
        id: 'backgroundColor',
        label: 'ë°°ê²½ìƒ‰',
        type: 'select',
        options: [
          { value: 'white', label: 'í°ìƒ‰' },
          { value: 'black', label: 'ê²€ì€ìƒ‰' },
          { value: 'gradient gray', label: 'ê·¸ë¼ë°ì´ì…˜ íšŒìƒ‰' }
        ]
      },
      {
        id: 'renderStyle',
        label: 'ë Œë”ë§ ìŠ¤íƒ€ì¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'flat vector black', label: 'í”Œë« ë²¡í„° ê²€ì€ìƒ‰' },
          { value: 'colorful 3D', label: 'ì»¬ëŸ¬í’€ 3D' },
          { value: 'minimalist line art', label: 'ë¯¸ë‹ˆë©€ ë¼ì¸ ì•„íŠ¸' }
        ]
      }
    ],
    promptTemplate: 'Create 8 minimalist logos. Each is a word related to {theme}, where {expressionStyle}. Composition: all logos on a single {backgroundColor} background, rendered in {renderStyle} style.'
  },

  chiaroscuro: {
    id: 'chiaroscuro',
    name: 'ëª…ì•”ë²• (Chiaroscuro)',
    icon: 'ğŸŒ“',
    category: 'artwork',
    description: 'ë“œë¼ë§ˆí‹±í•œ ëª…ì•” ëŒ€ë¹„ íš¨ê³¼',
    fields: [
      {
        id: 'subject',
        label: 'í”¼ì‚¬ì²´',
        type: 'textarea',
        placeholder: 'ì˜ˆ: ì¤‘ë…„ ë‚¨ì„±ì˜ ì¸¡ë©´ ì´ˆìƒí™”',
        required: true
      },
      {
        id: 'lightDirection',
        label: 'ì¡°ëª… ë°©í–¥',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'from above and slightly left', label: 'ìœ„ì™€ ì•½ê°„ ì™¼ìª½ì—ì„œ' },
          { value: 'from above and slightly right', label: 'ìœ„ì™€ ì•½ê°„ ì˜¤ë¥¸ìª½ì—ì„œ' },
          { value: 'from direct side left', label: 'ì™¼ìª½ ì¸¡ë©´ì—ì„œ' },
          { value: 'from below (horror style)', label: 'ì•„ë˜ì—ì„œ (í˜¸ëŸ¬ ìŠ¤íƒ€ì¼)' }
        ]
      },
      {
        id: 'highlightAreas',
        label: 'í•˜ì´ë¼ì´íŠ¸ ì˜ì—­',
        type: 'text',
        placeholder: 'ì˜ˆ: ëˆˆê³¼ ê´‘ëŒ€ë¼ˆë§Œ',
        helpText: 'ë¹›ì´ ë‹¿ëŠ” ë¶€ë¶„ì„ ì§€ì •'
      },
      {
        id: 'shadowIntensity',
        label: 'ê·¸ë¦¼ì ê°•ë„',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'deep and sharp', label: 'ê¹Šê³  ì„ ëª…í•œ' },
          { value: 'soft and gradual', label: 'ë¶€ë“œëŸ½ê³  ì ì§„ì ' },
          { value: 'extreme contrast', label: 'ê·¹ë‹¨ì  ëŒ€ë¹„' }
        ]
      },
      {
        id: 'mood',
        label: 'ë¶„ìœ„ê¸°',
        type: 'text',
        placeholder: 'ì˜ˆ: ì‹ ë¹„ë¡œìš´, ê·¹ì ì¸, ê³ ì „ì ì¸'
      }
    ],
    promptTemplate: 'Generate intense chiaroscuro effect. Harsh, directional lighting coming {lightDirection}. Cast {shadowIntensity} shadows. Only {highlightAreas} are illuminated by thin lines of light, rest in deep shadow. Subject: {subject}. Mood: {mood}.'
  },

  productLifestyle: {
    id: 'productLifestyle',
    name: 'ì œí’ˆ ë¼ì´í”„ìŠ¤íƒ€ì¼',
    icon: 'ğŸ“¦',
    category: 'professional',
    description: 'ì œí’ˆì„ ì—¬ëŸ¬ í™˜ê²½ì— ë°°ì¹˜',
    fields: [
      {
        id: 'productDescription',
        label: 'ì œí’ˆ ì„¤ëª…',
        type: 'textarea',
        placeholder: 'ì˜ˆ: ë¯¸ë‹ˆë©€í•œ ë””ìì¸ì˜ ìŠ¤í…Œì¸ë¦¬ìŠ¤ ìŠ¤í‹¸ í…€ë¸”ëŸ¬',
        required: true,
        helpText: 'ì œí’ˆì˜ í˜•íƒœ, ìƒ‰ìƒ, ì¬ì§ˆì„ ìƒì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”'
      },
      {
        id: 'scene1',
        label: 'ì¥ë©´ 1',
        type: 'text',
        placeholder: 'ì˜ˆ: ë§¥ë¶ê³¼ ì»¤í”¼ê°€ ìˆëŠ” ë¯¸ë‹ˆë©€í•œ í™ˆ ì˜¤í”¼ìŠ¤ ì±…ìƒ ìœ„'
      },
      {
        id: 'scene2',
        label: 'ì¥ë©´ 2',
        type: 'text',
        placeholder: 'ì˜ˆ: íƒ€ì›”ê³¼ ë¬¼ë³‘ì´ ìˆëŠ” í—¬ìŠ¤ì¥ ê°€ë°© ì•ˆ'
      },
      {
        id: 'scene3',
        label: 'ì¥ë©´ 3',
        type: 'text',
        placeholder: 'ì˜ˆ: ì™€ì¸ ì”ê³¼ ì´›ë¶ˆì´ ìˆëŠ” ë ˆìŠ¤í† ë‘ í…Œì´ë¸” ìœ„'
      },
      {
        id: 'scene4',
        label: 'ì¥ë©´ 4',
        type: 'text',
        placeholder: 'ì˜ˆ: ìˆ² ë“±ì‚°ë¡œì˜ ì—´ë¦° ë°±íŒ© ì•ˆ'
      },
      {
        id: 'consistency',
        label: 'ì¼ê´€ì„± ìœ ì§€ í•­ëª©',
        type: 'checkbox-group',
        options: [
          { value: 'same angle', label: 'ê°™ì€ ê°ë„' },
          { value: 'same material reflection', label: 'ê°™ì€ ì¬ì§ˆ ë°˜ì‚¬' },
          { value: 'same color', label: 'ê°™ì€ ìƒ‰ìƒ' },
          { value: 'same logo position', label: 'ê°™ì€ ë¡œê³  ìœ„ì¹˜' }
        ],
        defaultValue: ['same angle', 'same material reflection', 'same color', 'same logo position']
      },
      {
        id: 'lightingStyle',
        label: 'ì¡°ëª… ìŠ¤íƒ€ì¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'natural daylight', label: 'ìì—° ì£¼ê´‘' },
          { value: 'soft studio lighting', label: 'ì†Œí”„íŠ¸ ìŠ¤íŠœë””ì˜¤ ì¡°ëª…' },
          { value: 'dramatic side lighting', label: 'ë“œë¼ë§ˆí‹± ì‚¬ì´ë“œ ì¡°ëª…' },
          { value: 'warm golden hour', label: 'ë”°ëœ»í•œ ê³¨ë“ ì•„ì›Œ' }
        ]
      }
    ],
    promptTemplate: 'Show this product in 4 lifestyle scenes:\n1) {scene1}\n2) {scene2}\n3) {scene3}\n4) {scene4}\n\nProduct: {productDescription}\n\nProduct must remain identical across all images: {consistency}. Only environment, props, and lighting change. Lighting style: {lightingStyle}. Use natural depth of field. Output as 4 separate images optimized for e-commerce.'
  },

  // ===== Phase 4 ì¶”ê°€ í…œí”Œë¦¿ =====

  composite: {
    id: 'composite',
    name: 'ë‹¤ì¤‘ ì´ë¯¸ì§€ í•©ì„±',
    icon: 'ğŸ§©',
    category: 'professional',
    description: 'ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ë¡œ í•©ì„±',
    fields: [
      {
        id: 'aspectRatio',
        label: 'ìµœì¢… ì¢…íš¡ë¹„',
        type: 'select',
        options: [
          { value: '16:9', label: '16:9 ì™€ì´ë“œ' },
          { value: '1:1', label: '1:1 ì •ì‚¬ê°í˜•' },
          { value: '4:3', label: '4:3 ê°€ë¡œ' },
          { value: '9:16', label: '9:16 ì„¸ë¡œ' },
          { value: '3:4', label: '3:4 ì„¸ë¡œ' }
        ],
        required: true
      },
      {
        id: 'compositeInstructions',
        label: 'í•©ì„± ì§€ì‹œì‚¬í•­',
        type: 'textarea',
        placeholder: 'ê° ì´ë¯¸ì§€ì˜ ë°°ì¹˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.\nì˜ˆ: ì´ë¯¸ì§€ 1ì„ ì™¼ìª½ì—, ì´ë¯¸ì§€ 2ë¥¼ ì¤‘ì•™ í¬ê²Œ, ì´ë¯¸ì§€ 3ì„ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ì‘ê²Œ',
        required: true,
        helpText: 'ì²¨ë¶€ íŒ¨ë„ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš” (ìµœëŒ€ 14ê°œ)'
      },
      {
        id: 'lightingUnity',
        label: 'ì¡°ëª… í†µì¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'unified studio lighting from left', label: 'ì™¼ìª½ ìŠ¤íŠœë””ì˜¤ ì¡°ëª…' },
          { value: 'unified natural daylight', label: 'ìì—° ì£¼ê´‘' },
          { value: 'unified soft box at 45 degrees', label: 'ì†Œí”„íŠ¸ë°•ìŠ¤ 45ë„' },
          { value: 'unified golden hour warm lighting', label: 'ê³¨ë“ ì•„ì›Œ ë”°ëœ»í•œ ì¡°ëª…' }
        ]
      },
      {
        id: 'shadowDirection',
        label: 'ê·¸ë¦¼ì ë°©í–¥',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'consistent shadows to the right', label: 'ì˜¤ë¥¸ìª½ìœ¼ë¡œ í†µì¼' },
          { value: 'consistent shadows to the left', label: 'ì™¼ìª½ìœ¼ë¡œ í†µì¼' },
          { value: 'consistent shadows below', label: 'ì•„ë˜ë¡œ í†µì¼' },
          { value: 'soft diffused shadows', label: 'ë¶€ë“œëŸ½ê²Œ í™•ì‚°' }
        ]
      },
      {
        id: 'background',
        label: 'ë°°ê²½',
        type: 'text',
        placeholder: 'ì˜ˆ: ê·¸ë¼ë°ì´ì…˜ íšŒìƒ‰, í°ìƒ‰ ìŠ¤íŠœë””ì˜¤, ë„ì‹œ ì•¼ê²½'
      },
      {
        id: 'additional',
        label: 'ì¶”ê°€ ì§€ì‹œì‚¬í•­',
        type: 'textarea',
        placeholder: 'ìƒ‰ê° í†µì¼, ë¸”ë Œë”© ë°©ì‹ ë“±...'
      }
    ],
    promptTemplate: 'Composite the uploaded images into a single {aspectRatio} image. {compositeInstructions}. Apply {lightingUnity} with {shadowDirection}. Background: {background}. {additional}'
  },

  magazine: {
    id: 'magazine',
    name: 'ë§¤ê±°ì§„ ì»¤ë²„',
    icon: 'ğŸ“°',
    category: 'typography',
    description: 'ê´‘íƒ ë§¤ê±°ì§„ ì»¤ë²„ ìŠ¤íƒ€ì¼',
    fields: [
      {
        id: 'title',
        label: 'ë§¤ê±°ì§„ ì œëª©',
        type: 'text',
        placeholder: 'ì˜ˆ: VOGUE, TIME, ELLE',
        required: true,
        helpText: '25ì ì´í•˜ ê¶Œì¥'
      },
      {
        id: 'personDescription',
        label: 'ì¸ë¬¼ ì„¤ëª…',
        type: 'textarea',
        placeholder: 'ì˜ˆ: ë…¹ìƒ‰ê³¼ ê³¨ë“œ ê³ ê¸‰ íŒ¨ì…˜ì„ ì…ì€ ë‹¤ì´ë‚˜ë¯¹í•œ ì¸ë¬¼'
      },
      {
        id: 'fontStyle',
        label: 'í°íŠ¸ ìŠ¤íƒ€ì¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'bold serif black-white', label: 'êµµì€ ì„¸ë¦¬í”„ í‘ë°±' },
          { value: 'elegant script gold', label: 'ìš°ì•„í•œ í•„ê¸°ì²´ ê³¨ë“œ' },
          { value: 'modern sans-serif white', label: 'ëª¨ë˜ ì‚°ì„¸ë¦¬í”„ í°ìƒ‰' },
          { value: 'vintage art deco', label: 'ë¹ˆí‹°ì§€ ì•„íŠ¸ë°ì½”' }
        ]
      },
      {
        id: 'issueInfo',
        label: 'ë°œí–‰ ì •ë³´',
        type: 'text',
        placeholder: 'ì˜ˆ: 2025ë…„ 12ì›”í˜¸, $15.99'
      },
      {
        id: 'extras',
        label: 'ì¶”ê°€ ìš”ì†Œ',
        type: 'checkbox-group',
        options: [
          { value: 'barcode in corner', label: 'ë°”ì½”ë“œ' },
          { value: 'issue number displayed', label: 'ë°œí–‰ í˜¸ìˆ˜' },
          { value: 'price tag visible', label: 'ê°€ê²©í‘œ' }
        ]
      }
    ],
    promptTemplate: 'Glossy magazine cover photo. Cover displays "{title}" in large {fontStyle} font filling the top. In front of the text, {personDescription}. Corner includes {issueInfo}. {extras}. Magazine resting on white shelf leaning against wall.'
  },

  quilling: {
    id: 'quilling',
    name: 'í˜ì´í¼ í€¼ë§',
    icon: 'ğŸ€',
    category: 'artwork',
    description: 'ì¢…ì´ ë ë¡œ ë§Œë“  ì…ì²´ ì•„íŠ¸ì›Œí¬',
    fields: [
      {
        id: 'text',
        label: 'í‘œí˜„í•  í…ìŠ¤íŠ¸',
        type: 'text',
        placeholder: 'ì˜ˆ: MAGIC, LOVE, DREAM',
        required: true,
        helpText: 'ì§§ì€ ë‹¨ì–´ ê¶Œì¥ (1-2ë‹¨ì–´)'
      },
      {
        id: 'colors',
        label: 'ì¢…ì´ ë  ìƒ‰ìƒ',
        type: 'text',
        placeholder: 'ì˜ˆ: ë³´ë¼ìƒ‰, í•‘í¬, ë§ˆì  íƒ€, í°ìƒ‰',
        helpText: 'ì½¤ë§ˆë¡œ ì—¬ëŸ¬ ìƒ‰ìƒ êµ¬ë¶„'
      },
      {
        id: 'backgroundColor',
        label: 'ë°°ê²½ìƒ‰',
        type: 'text',
        placeholder: 'ì˜ˆ: ì§„íšŒìƒ‰, í¬ë¦¼ìƒ‰, ê²€ì€ìƒ‰'
      },
      {
        id: 'scriptStyle',
        label: 'ê¸€ì”¨ ìŠ¤íƒ€ì¼',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'elaborate calligraphy script', label: 'ì •êµí•œ ìº˜ë¦¬ê·¸ë˜í”¼' },
          { value: 'bold block letters', label: 'êµµì€ ë¸”ë¡ ê¸€ì' },
          { value: 'flowing cursive', label: 'íë¥´ëŠ” í•„ê¸°ì²´' },
          { value: 'decorative ornamental', label: 'ì¥ì‹ì  ì˜¤ë„ˆë©˜íƒˆ' }
        ]
      },
      {
        id: 'depth',
        label: 'ì…ì²´ê° ìˆ˜ì¤€',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'subtle 3D depth', label: 'ì€ì€í•œ ì…ì²´ê°' },
          { value: 'pronounced layered depth', label: 'ëšœë ·í•œ ë ˆì´ì–´ ê¹Šì´' },
          { value: 'extreme sculptural depth', label: 'ê·¹ì ì¸ ì¡°ê°ì  ê¹Šì´' }
        ]
      }
    ],
    promptTemplate: 'Paper quilling artwork, rendered with {colors} paper strips. The word "{text}" expressed in {scriptStyle}. Paper strips create {depth} and natural shadows, placed on {backgroundColor} textured background.'
  },

  material: {
    id: 'material',
    name: 'ì¬ë£Œ/í…ìŠ¤ì²˜',
    icon: 'ğŸª¨',
    category: 'artwork',
    description: 'ì˜¤ë¸Œì íŠ¸ë¥¼ íŠ¹ì • ì¬ë£Œë¡œ í‘œí˜„',
    fields: [
      {
        id: 'targetObject',
        label: 'ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸',
        type: 'textarea',
        placeholder: 'ì˜ˆ: ì‚¬ê³¼, ìë™ì°¨, ì¸ê°„ ì–¼êµ´',
        required: true
      },
      {
        id: 'material',
        label: 'ì¬ë£Œ',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'polished marble', label: 'ê´‘íƒ ëŒ€ë¦¬ì„' },
          { value: 'rough granite', label: 'ê±°ì¹œ í™”ê°•ì•”' },
          { value: 'liquid mercury', label: 'ì•¡ì²´ ìˆ˜ì€' },
          { value: 'cracked porcelain', label: 'ê¸ˆê°„ ë„ìê¸°' },
          { value: 'weathered bronze', label: 'í’í™”ëœ ì²­ë™' },
          { value: 'ice crystal', label: 'ì–¼ìŒ ê²°ì •' },
          { value: 'molten lava', label: 'ë…¹ì€ ìš©ì•”' },
          { value: 'woven fabric', label: 'ì§ì¡° ì²œ' },
          { value: 'transparent glass', label: 'íˆ¬ëª… ìœ ë¦¬' }
        ]
      },
      {
        id: 'textureDetails',
        label: 'í…ìŠ¤ì²˜ ë””í…Œì¼',
        type: 'text',
        placeholder: 'ì˜ˆ: ê· ì—´, ë°˜ì‚¬, ì§ˆê°, í‘œë©´ ì²˜ë¦¬'
      },
      {
        id: 'lighting',
        label: 'ì¡°ëª…',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'studio lighting for material showcase', label: 'ì¬ì§ˆ ì‡¼ì¼€ì´ìŠ¤ìš© ìŠ¤íŠœë””ì˜¤ ì¡°ëª…' },
          { value: 'dramatic side lighting', label: 'ë“œë¼ë§ˆí‹± ì‚¬ì´ë“œ ì¡°ëª…' },
          { value: 'soft ambient lighting', label: 'ë¶€ë“œëŸ¬ìš´ í™˜ê²½ ì¡°ëª…' }
        ]
      },
      {
        id: 'background',
        label: 'ë°°ê²½',
        type: 'text',
        placeholder: 'ì˜ˆ: ê²€ì€ ë°°ê²½, ê·¸ë¼ë°ì´ì…˜, ìì—°í™˜ê²½'
      }
    ],
    promptTemplate: 'Create {targetObject} made entirely of {material}. The surface shows {textureDetails}. Lighting: {lighting}. Background: {background}. Photorealistic render emphasizing the material properties.'
  },

  cityLettering: {
    id: 'cityLettering',
    name: 'ë„ì‹œ ë ˆí„°ë§',
    icon: 'ğŸ™ï¸',
    category: 'artwork',
    description: 'ê±´ë¬¼ë¡œ ê¸€ì í˜•íƒœ í‘œí˜„',
    fields: [
      {
        id: 'city',
        label: 'ë„ì‹œ',
        type: 'text',
        placeholder: 'ì˜ˆ: ë² ë¥¼ë¦°, ì„œìš¸, ë„ì¿„, ë‰´ìš•',
        required: true
      },
      {
        id: 'word',
        label: 'í‘œí˜„í•  ë‹¨ì–´',
        type: 'text',
        placeholder: 'ì˜ˆ: BERLIN, SEOUL',
        required: true,
        helpText: 'ë„ì‹œ ì´ë¦„ ë˜ëŠ” ì§§ì€ ë‹¨ì–´ ê¶Œì¥'
      },
      {
        id: 'buildingColors',
        label: 'ê±´ë¬¼ ìƒ‰ìƒ',
        type: 'text',
        placeholder: 'ì˜ˆ: íŒŒë€ìƒ‰, ë¹¨ê°„ìƒ‰, í°ìƒ‰, ê²€ì€ìƒ‰'
      },
      {
        id: 'timeOfDay',
        label: 'ì‹œê°„ëŒ€',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'bright sunny day', label: 'ë°ì€ í–‡ì‚´ ë‚®' },
          { value: 'golden hour sunset', label: 'ê³¨ë“ ì•„ì›Œ ì„ì–‘' },
          { value: 'blue hour twilight', label: 'ë¸”ë£¨ì•„ì›Œ í™©í˜¼' },
          { value: 'night with city lights', label: 'ë„ì‹œ ë¶ˆë¹› ë°¤' }
        ]
      },
      {
        id: 'perspective',
        label: 'ì‹œì ',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: 'street level view', label: 'ê±°ë¦¬ ì‹œì ' },
          { value: 'aerial view', label: 'ê³µì¤‘ ì‹œì ' },
          { value: 'wide panoramic', label: 'ì™€ì´ë“œ íŒŒë…¸ë¼ë§ˆ' }
        ]
      }
    ],
    promptTemplate: '{timeOfDay} {city} street view. Old buildings arranged subtly in the shape of the letters "{word}". Buildings painted in {buildingColors}. Buildings still look like buildings, similarity to letters is subtle. {perspective}. Strong shadows, sharp details.'
  },

  lightingPro: {
    id: 'lightingPro',
    name: 'ì¡°ëª… ì •ë°€ ì œì–´',
    icon: 'ğŸ’¡',
    category: 'professional',
    description: 'ê¸°ìˆ ì  ì¡°ëª… ì–¸ì–´ë¡œ ì •í™•í•œ ì¡°ëª… ì„¤ì •',
    fields: [
      {
        id: 'subject',
        label: 'í”¼ì‚¬ì²´/ì¥ë©´',
        type: 'textarea',
        placeholder: 'ì˜ˆ: í”„ë¦¬ë¯¸ì—„ ì‹œê³„ ì œí’ˆ ì‚¬ì§„, ì¸ë¬¼ ì´ˆìƒí™”',
        required: true
      },
      {
        id: 'colorTemp',
        label: 'ìƒ‰ì˜¨ë„',
        type: 'select',
        options: [
          { value: '', label: 'ì„ íƒí•˜ì„¸ìš”' },
          { value: '5600K daylight balanced', label: '5600K ì£¼ê´‘' },
          { value: '3200K tungsten warm', label: '3200K í……ìŠ¤í… ë”°ëœ»í•¨' },
          { value: '6500K cool daylight', label: '6500K ì¿¨ ë°ì´ë¼ì´íŠ¸' },
          { value: 'mixed warm key and cool fill', label: 'í˜¼í•© (ë”°ëœ»í•¨ í‚¤ + ì°¨ê°€ì›€ í•„)' }
        ]
      },
      {
        id: 'keyLight',
        label: 'í‚¤ ë¼ì´íŠ¸',
        type: 'text',
        placeholder: 'ì˜ˆ: ì™¼ìª½ ìƒë‹¨ì—ì„œ 45ë„ ê°ë„, ì†Œí”„íŠ¸ë°•ìŠ¤',
        helpText: 'ì£¼ìš” ì¡°ëª…ì˜ ìœ„ì¹˜, ê°ë„, ìˆ˜ì‹ì–´'
      },
      {
        id: 'fillLight',
        label: 'í•„ ë¼ì´íŠ¸',
        type: 'text',
        placeholder: 'ì˜ˆ: ì˜¤ë¥¸ìª½ì—ì„œ 30% ê°•ë„ì˜ ë°˜ì‚¬íŒ',
        helpText: 'ê·¸ë¦¼ìë¥¼ ì±„ìš°ëŠ” ë³´ì¡° ì¡°ëª…'
      },
      {
        id: 'rimLight',
        label: 'ë¦¼/ë°± ë¼ì´íŠ¸',
        type: 'text',
        placeholder: 'ì˜ˆ: ë’¤ì—ì„œ í”¼ì‚¬ì²´ ê°€ì¥ìë¦¬ë¥¼ ê°•ì¡°í•˜ëŠ” ì–‡ì€ ë¹›',
        helpText: 'í”¼ì‚¬ì²´ ìœ¤ê³½ì„ ë¶„ë¦¬í•˜ëŠ” ì¡°ëª…'
      },
      {
        id: 'surface',
        label: 'ë°°ì¹˜ í‘œë©´',
        type: 'text',
        placeholder: 'ì˜ˆ: ê²€ì€ ì•„í¬ë¦´ í‘œë©´ì— ë°˜ì‚¬, í°ìƒ‰ ë¬´ê´‘ í…Œì´ë¸”'
      }
    ],
    promptTemplate: '{subject}. Professional lighting setup: {colorTemp} color temperature. Key light: {keyLight}. Fill light: {fillLight}. Rim/back light: {rimLight}. Subject placed on {surface}. Studio photography quality.'
  }
};


// ===== state.js =====
// ===== STATE =====


const state = {
  apiKey: '',
  apiStatus: 'disconnected', // 'disconnected' | 'testing' | 'connected' | 'error'
  currentTemplate: 'basic',
  fieldValues: {},
  generatedImage: null,
  isLoading: false,
  error: null,
  // Phase 2 ì¶”ê°€
  workMode: 'explore', // 'explore' | 'refine' | 'final'
  attachedImages: [], // { id, file, originalSize, processedSize, base64, thumbnail, width, height }
  selectedImageId: null,
  resultHistory: [], // { id, prompt, translatedPrompt, image: { mimeType, data }, timestamp }
  selectedResultId: null,
  autoTranslate: false,
  translatedPrompt: '',
  isTranslating: false,
  promptTab: 'original', // 'original' | 'translated'
  imageModalIndex: -1,
  // Phase 3 ì¶”ê°€
  thinkingMode: false,
  editSession: {
    sessionId: null,
    basePrompt: '',
    editHistory: [], // { id, step, request, prompt, image, timestamp }
    currentEditIndex: -1
  },
  presetCategory: 'lighting',
  // Phase 4 ì¶”ê°€
  promptHistory: [], // { id, prompt, translatedPrompt, templateId, timestamp }
  promptHistorySearch: '',
  customTemplates: {}, // { templateId: templateObject }
  editingTemplate: null, // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ í…œí”Œë¦¿ ID
  templateEditorFields: [], // í¸ì§‘ê¸°ì˜ í•„ë“œ ëª©ë¡
  canvasSettings: {
    aspectRatio: '1:1',
    customWidth: 1024,
    customHeight: 1024,
    baseSize: 1024,
    backgroundColor: '#FFFFFF',
    backgroundType: 'white' // 'white' | 'transparent' | 'custom'
  }
};

// í…œí”Œë¦¿ë³„ ê¸°ë³¸ê°’ ì´ˆê¸°í™”
function initializeFieldValues() {
  Object.keys(TEMPLATES).forEach(templateId => {
    state.fieldValues[templateId] = {};
    TEMPLATES[templateId].fields.forEach(field => {
      if (field.defaultValue !== undefined) {
        state.fieldValues[templateId][field.id] = field.defaultValue;
      } else if (field.type === 'checkbox-group') {
        state.fieldValues[templateId][field.id] = [];
      } else if (field.type === 'checkbox') {
        state.fieldValues[templateId][field.id] = false;
      } else {
        state.fieldValues[templateId][field.id] = '';
      }
    });
  });
}

// ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì˜ í•„ë“œê°’ë„ ì´ˆê¸°í™”
function initializeCustomTemplateFieldValues(templateId, template) {
  state.fieldValues[templateId] = {};
  template.fields.forEach(field => {
    if (field.defaultValue !== undefined) {
      state.fieldValues[templateId][field.id] = field.defaultValue;
    } else if (field.type === 'checkbox-group') {
      state.fieldValues[templateId][field.id] = [];
    } else if (field.type === 'checkbox') {
      state.fieldValues[templateId][field.id] = false;
    } else {
      state.fieldValues[templateId][field.id] = '';
    }
  });
}


// ===== config.js =====
// ===== CONFIG =====

const STORAGE_KEYS = {
  API_KEY: 'nano_banana_api_key',
  SETTINGS: 'nano_banana_settings',
  HISTORY: 'nano_banana_history',
  PROMPT_HISTORY: 'nano_banana_prompt_history',
  CUSTOM_TEMPLATES: 'nano_banana_custom_templates'
};

const API_ENDPOINTS = {
  TEXT: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
  IMAGE: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent'
};

const API_ERRORS = {
  400: 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.',
  401: 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
  403: 'ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. API í‚¤ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
  429: 'ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
  500: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
  'NETWORK_ERROR': 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
  'IMAGE_SAFETY': 'ì•ˆì „ í•„í„°ì— ì˜í•´ ì´ë¯¸ì§€ ìƒì„±ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'
};

// Thinking ëª¨ë“œ í”„ë¦¬í”½ìŠ¤ í…œí”Œë¦¿
const THINKING_PREFIX = `Before generating this image:
1. Analyze the core objective of my request
2. Verify logical consistency of physics, lighting, and composition
3. Establish relationships and priorities between elements
4. Review potential error points (e.g., text spelling, proportions)

Then generate:
`;

// ë¹ ë¥¸ ìˆ˜ì • í”„ë¦¬ì…‹ ë°ì´í„°
const QUICK_PRESETS = {
  lighting: {
    id: 'lighting',
    name: 'ğŸ’¡ ì¡°ëª…',
    presets: [
      { id: 'warmer', label: 'ë” ë”°ëœ»í•˜ê²Œ', prompt: 'Make the lighting warmer with golden tones' },
      { id: 'cooler', label: 'ë” ì°¨ê°‘ê²Œ', prompt: 'Make the lighting cooler with blue tones' },
      { id: 'shadow_strong', label: 'ê·¸ë¦¼ì ê°•í™”', prompt: 'Enhance shadows for more dramatic contrast' },
      { id: 'shadow_soft', label: 'ê·¸ë¦¼ì ë¶€ë“œëŸ½ê²Œ', prompt: 'Soften shadows for a more gentle look' },
      { id: 'backlight', label: 'ì—­ê´‘ ì¶”ê°€', prompt: 'Add backlighting/rim light behind the subject' }
    ]
  },
  color: {
    id: 'color',
    name: 'ğŸ¨ ìƒ‰ìƒ',
    presets: [
      { id: 'saturation_up', label: 'ì±„ë„ +15%', prompt: 'Increase color saturation by 15%' },
      { id: 'saturation_down', label: 'ì±„ë„ -15%', prompt: 'Decrease color saturation by 15%' },
      { id: 'contrast_up', label: 'ëŒ€ë¹„ ë†’ì´ê¸°', prompt: 'Increase contrast for more vivid colors' },
      { id: 'vintage', label: 'ë¹ˆí‹°ì§€ í†¤', prompt: 'Apply vintage/retro color grading' },
      { id: 'monochrome', label: 'ëª¨ë…¸í¬ë¡¬', prompt: 'Convert to monochrome/black and white' }
    ]
  },
  elements: {
    id: 'elements',
    name: 'ğŸ§© ìš”ì†Œ',
    presets: [
      { id: 'add_logo', label: 'ë¡œê³  ì¶”ê°€', prompt: 'Add a subtle logo placeholder in the corner' },
      { id: 'add_text', label: 'í…ìŠ¤íŠ¸ ì¶”ê°€', prompt: 'Add text overlay space' },
      { id: 'change_bg', label: 'ë°°ê²½ ë³€ê²½', prompt: 'Change the background to a neutral/clean background' },
      { id: 'add_props', label: 'ì†Œí’ˆ ì¶”ê°€', prompt: 'Add complementary props/accessories to the scene' }
    ]
  },
  style: {
    id: 'style',
    name: 'ğŸ–Œï¸ ìŠ¤íƒ€ì¼',
    presets: [
      { id: 'more_realistic', label: 'ë” ì‚¬ì‹¤ì ìœ¼ë¡œ', prompt: 'Make it more photorealistic with natural details' },
      { id: 'more_illustration', label: 'ë” ì¼ëŸ¬ìŠ¤íŠ¸í’ìœ¼ë¡œ', prompt: 'Make it more illustrated/artistic style' },
      { id: 'film_grain', label: 'í•„ë¦„ ê·¸ë ˆì¸ ì¶”ê°€', prompt: 'Add subtle film grain texture' },
      { id: 'cinematic', label: 'ì‹œë„¤ë§ˆí‹±', prompt: 'Apply cinematic look with letterbox aspect ratio feel' }
    ]
  }
};

// ì‘ì—… ëª¨ë“œ ì„¤ì •
const WORK_MODES = {
  explore: {
    id: 'explore',
    name: 'íƒìƒ‰',
    icon: 'ğŸ”',
    maxSize: 512,
    quality: 0.6,
    description: 'ë¹ ë¥¸ ë³€í˜• ìƒì„±ìš© (512px, 60% í’ˆì§ˆ)'
  },
  refine: {
    id: 'refine',
    name: 'ì •ì œ',
    icon: 'âœ¨',
    maxSize: 1024,
    quality: 0.8,
    description: 'ì„¸ë¶€ ì¡°ì •ìš© (1024px, 80% í’ˆì§ˆ)'
  },
  final: {
    id: 'final',
    name: 'ìµœì¢…',
    icon: 'ğŸ“¸',
    maxSize: null,
    quality: 1.0,
    description: 'í”„ë¡œë•ì…˜ ì¶œë ¥ìš© (ì›ë³¸ í•´ìƒë„)'
  }
};

// ì¢…íš¡ë¹„ í”„ë¦¬ì…‹ (ìº”ë²„ìŠ¤ ìƒì„±ê¸°ìš©)
const ASPECT_RATIO_PRESETS = [
  { id: 'square', ratio: '1:1', width: 1, height: 1, label: 'ì •ì‚¬ê°í˜•' },
  { id: 'landscape43', ratio: '4:3', width: 4, height: 3, label: 'ê°€ë¡œ 4:3' },
  { id: 'landscape169', ratio: '16:9', width: 16, height: 9, label: 'ê°€ë¡œ 16:9' },
  { id: 'portrait34', ratio: '3:4', width: 3, height: 4, label: 'ì„¸ë¡œ 3:4' },
  { id: 'portrait916', ratio: '9:16', width: 9, height: 16, label: 'ì„¸ë¡œ 9:16' }
];


// ===== storage.js =====
// ===== STORAGE =====


function loadFromStorage() {
  try {
    const savedApiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
    if (savedApiKey) {
      state.apiKey = savedApiKey;
      const apiKeyInput = document.getElementById('apiKeyInput');
      if (apiKeyInput) {
        apiKeyInput.value = savedApiKey;
      }
      return savedApiKey; // API í‚¤ë¥¼ ë°˜í™˜í•˜ì—¬ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ê²Œ í•¨
    }
  } catch (e) {
    console.error('Failed to load from storage:', e);
  }
  return null;
}

function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEYS.API_KEY, state.apiKey);
  } catch (e) {
    console.error('Failed to save to storage:', e);
  }
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ì €ì¥
function savePromptHistory() {
  try {
    localStorage.setItem(STORAGE_KEYS.PROMPT_HISTORY, JSON.stringify(state.promptHistory));
  } catch (e) {
    console.error('Failed to save prompt history:', e);
  }
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ë¡œë“œ
function loadPromptHistory() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.PROMPT_HISTORY);
    if (saved) {
      state.promptHistory = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Failed to load prompt history:', e);
    state.promptHistory = [];
  }
}

// ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì €ì¥
function saveCustomTemplates() {
  try {
    localStorage.setItem(STORAGE_KEYS.CUSTOM_TEMPLATES, JSON.stringify(state.customTemplates));
  } catch (e) {
    console.error('Failed to save custom templates:', e);
  }
}

// ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ë¡œë“œ
function loadCustomTemplates() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.CUSTOM_TEMPLATES);
    if (saved) {
      state.customTemplates = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Failed to load custom templates:', e);
    state.customTemplates = {};
  }
}

// ì„¤ì • ì €ì¥
function saveSettings() {
  try {
    const settings = {
      workMode: state.workMode,
      autoTranslate: state.autoTranslate,
      thinkingMode: state.thinkingMode
    };
    localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
  } catch (e) {
    console.error('Failed to save settings:', e);
  }
}

// ì„¤ì • ë¡œë“œ
function loadSettings() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.SETTINGS);
    if (saved) {
      const settings = JSON.parse(saved);
      if (settings.workMode) state.workMode = settings.workMode;
      if (settings.autoTranslate !== undefined) state.autoTranslate = settings.autoTranslate;
      if (settings.thinkingMode !== undefined) state.thinkingMode = settings.thinkingMode;
    }
  } catch (e) {
    console.error('Failed to load settings:', e);
  }
}


// ===== prompt-builder.js =====
// ===== PROMPT BUILDER =====


// í”„ë¡¬í”„íŠ¸ ë¹Œë“œ
function buildPrompt(templateId, values) {
  const template = TEMPLATES[templateId] || state.customTemplates[templateId];
  if (!template) return '';

  let prompt = template.promptTemplate;

  // ê° í•„ë“œ ê°’ì„ í…œí”Œë¦¿ì— ëŒ€ì…
  template.fields.forEach(field => {
    const value = values[field.id];
    let replacement = '';

    if (field.type === 'checkbox-group' && Array.isArray(value)) {
      replacement = value.join(', ');
    } else if (field.type === 'checkbox') {
      replacement = value ? 'yes' : '';
    } else {
      replacement = value || '';
    }

    // ì•¡ì…˜ê³¼ ìœ„ì¹˜ í•„ë“œëŠ” ì•ì— ê³µë°±ì´ë‚˜ ì ‘ì†ì‚¬ ì¶”ê°€
    if (field.id === 'action' && replacement) {
      replacement = ', ' + replacement;
    }
    if (field.id === 'location' && replacement) {
      replacement = ' in ' + replacement;
    }

    prompt = prompt.replace(new RegExp(`\\{${field.id}\\}`, 'g'), replacement);
  });

  // ë¹ˆ ìë¦¬í‘œì‹œìì™€ ë¶ˆí•„ìš”í•œ ë¬¸ì¥ë¶€í˜¸ ì •ë¦¬
  prompt = prompt
    .replace(/\{[^}]+\}/g, '') // ë‚¨ì€ ìë¦¬í‘œì‹œì ì œê±°
    .replace(/\s+/g, ' ') // ë‹¤ì¤‘ ê³µë°± ì œê±°
    .replace(/\s*,\s*,/g, ',') // ì¤‘ë³µ ì‰¼í‘œ ì œê±°
    .replace(/,\s*\./g, '.') // ì‰¼í‘œ í›„ ë§ˆì¹¨í‘œ ì •ë¦¬
    .replace(/\.\s*\./g, '.') // ì¤‘ë³µ ë§ˆì¹¨í‘œ ì œê±°
    .replace(/\s+\./g, '.') // ë§ˆì¹¨í‘œ ì „ ê³µë°± ì œê±°
    .replace(/^\s*,\s*/g, '') // ì‹œì‘ ì‰¼í‘œ ì œê±°
    .replace(/,\s*$/g, '') // ë ì‰¼í‘œ ì œê±°
    .trim();

  return prompt;
}

// í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePromptPreview() {
  const prompt = buildPrompt(state.currentTemplate, state.fieldValues[state.currentTemplate]);
  const previewEl = document.getElementById('promptPreview');

  if (!previewEl) return;

  if (prompt && prompt.length > 10) {
    previewEl.textContent = prompt;
    previewEl.classList.remove('empty');
  } else {
    previewEl.textContent = 'í•„ë“œë¥¼ ì…ë ¥í•˜ë©´ í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.';
    previewEl.classList.add('empty');
  }
}

// í”„ë¡¬í”„íŠ¸ ë³µì‚¬
async function copyPromptToClipboard() {
  const prompt = buildPrompt(state.currentTemplate, state.fieldValues[state.currentTemplate]);
  if (!prompt) return false;

  try {
    await navigator.clipboard.writeText(prompt);
    return true;
  } catch (e) {
    console.error('Failed to copy prompt:', e);
    return false;
  }
}

// í˜„ì¬ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
function getCurrentPrompt() {
  return buildPrompt(state.currentTemplate, state.fieldValues[state.currentTemplate]);
}


// ===== render-templates.js =====
// ===== RENDER TEMPLATES =====


// í…œí”Œë¦¿ íƒ­ ë Œë”ë§
function renderTemplateTabs() {
  const container = document.getElementById('templateTabs');
  if (!container) return;

  container.innerHTML = '';

  // ê¸°ë³¸ í…œí”Œë¦¿ ë Œë”ë§
  Object.values(TEMPLATES).forEach(template => {
    const tab = document.createElement('button');
    tab.className = `template-tab ${state.currentTemplate === template.id ? 'active' : ''}`;
    tab.onclick = () => window.handleTemplateChange(template.id);
    tab.innerHTML = `
      <span class="icon">${template.icon}</span>
      <span>${template.name}</span>
    `;
    container.appendChild(tab);
  });

  // ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ êµ¬ë¶„ì„ ê³¼ ì»¤ìŠ¤í…€ íƒ­ ì¶”ê°€
  if (Object.keys(state.customTemplates).length > 0) {
    const divider = document.createElement('div');
    divider.className = 'template-tab-divider';
    divider.innerHTML = '|';
    container.appendChild(divider);

    Object.values(state.customTemplates).forEach(template => {
      const tab = document.createElement('button');
      tab.className = `template-tab template-tab-custom ${state.currentTemplate === template.id ? 'active' : ''}`;
      tab.onclick = () => window.handleTemplateChange(template.id);
      tab.innerHTML = `
        <span class="icon">${template.icon}</span>
        <span>${template.name}</span>
      `;
      container.appendChild(tab);
    });
  }

  // "ìƒˆ í…œí”Œë¦¿" ë²„íŠ¼
  const addBtn = document.createElement('button');
  addBtn.className = 'template-tab template-tab-add';
  addBtn.onclick = () => window.openTemplateEditor();
  addBtn.innerHTML = `
    <span class="icon">â•</span>
    <span>ìƒˆ í…œí”Œë¦¿</span>
  `;
  container.appendChild(addBtn);
}

// í…œí”Œë¦¿ í•„ë“œ ë Œë”ë§
function renderTemplateFields() {
  const container = document.getElementById('templateForm');
  if (!container) return;

  // ê¸°ë³¸ ë˜ëŠ” ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸°
  const template = TEMPLATES[state.currentTemplate] || state.customTemplates[state.currentTemplate];

  if (!template) {
    container.innerHTML = '<p class="form-help">í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  const values = state.fieldValues[state.currentTemplate];
  container.innerHTML = '';

  // ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì¸ ê²½ìš° í¸ì§‘/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
  if (template.isCustom) {
    const customActions = document.createElement('div');
    customActions.className = 'custom-template-actions';
    customActions.innerHTML = `
      <button class="btn btn-outline btn-sm" onclick="openTemplateEditor('${template.id}')">âœï¸ í¸ì§‘</button>
      <button class="btn btn-outline btn-sm" onclick="duplicateTemplate('${template.id}')">ğŸ“‹ ë³µì œ</button>
      <button class="btn btn-outline btn-sm" onclick="exportTemplate('${template.id}')">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-outline btn-sm btn-danger" onclick="deleteCustomTemplate('${template.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
    `;
    container.appendChild(customActions);
  } else {
    // ê¸°ë³¸ í…œí”Œë¦¿ ë³µì œ ë²„íŠ¼
    const duplicateBtn = document.createElement('div');
    duplicateBtn.className = 'template-duplicate-btn';
    duplicateBtn.innerHTML = `
      <button class="btn btn-outline btn-sm" onclick="duplicateTemplate('${template.id}')">ğŸ“‹ ì´ í…œí”Œë¦¿ ë³µì œí•˜ì—¬ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ</button>
    `;
    container.appendChild(duplicateBtn);
  }

  template.fields.forEach(field => {
    const group = document.createElement('div');
    group.className = 'form-group';

    // ë¼ë²¨
    const label = document.createElement('label');
    label.className = 'form-label';
    label.innerHTML = field.label + (field.required ? ' <span class="required">*</span>' : '');
    group.appendChild(label);

    // ì…ë ¥ í•„ë“œ ë Œë”ë§
    let input;

    switch (field.type) {
      case 'text':
        input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-input';
        input.placeholder = field.placeholder || '';
        input.value = values[field.id] || '';
        input.oninput = (e) => {
          state.fieldValues[state.currentTemplate][field.id] = e.target.value;
          updatePromptPreview();
        };
        break;

      case 'textarea':
        input = document.createElement('textarea');
        input.className = 'form-textarea';
        input.placeholder = field.placeholder || '';
        input.value = values[field.id] || '';
        input.oninput = (e) => {
          state.fieldValues[state.currentTemplate][field.id] = e.target.value;
          updatePromptPreview();
        };
        break;

      case 'select':
        input = document.createElement('select');
        input.className = 'form-select';
        field.options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if (values[field.id] === opt.value) {
            option.selected = true;
          }
          input.appendChild(option);
        });
        input.onchange = (e) => {
          state.fieldValues[state.currentTemplate][field.id] = e.target.value;
          updatePromptPreview();
        };
        break;

      case 'checkbox':
        input = document.createElement('label');
        input.className = 'form-checkbox-label';
        input.innerHTML = `
          <input type="checkbox" ${values[field.id] ? 'checked' : ''}>
          <span>í™œì„±í™”</span>
        `;
        input.querySelector('input').onchange = (e) => {
          state.fieldValues[state.currentTemplate][field.id] = e.target.checked;
          updatePromptPreview();
        };
        break;

      case 'checkbox-group':
        input = document.createElement('div');
        input.className = 'form-checkbox-group';
        field.options.forEach(opt => {
          const checkLabel = document.createElement('label');
          checkLabel.className = 'form-checkbox-label';
          const isChecked = Array.isArray(values[field.id]) && values[field.id].includes(opt.value);
          checkLabel.innerHTML = `
            <input type="checkbox" value="${opt.value}" ${isChecked ? 'checked' : ''}>
            <span>${opt.label}</span>
          `;
          checkLabel.querySelector('input').onchange = (e) => {
            const currentValues = state.fieldValues[state.currentTemplate][field.id] || [];
            if (e.target.checked) {
              state.fieldValues[state.currentTemplate][field.id] = [...currentValues, opt.value];
            } else {
              state.fieldValues[state.currentTemplate][field.id] = currentValues.filter(v => v !== opt.value);
            }
            updatePromptPreview();
          };
          input.appendChild(checkLabel);
        });
        break;
    }

    if (input) {
      group.appendChild(input);
    }

    // ë„ì›€ë§
    if (field.helpText) {
      const help = document.createElement('p');
      help.className = 'form-help';
      help.textContent = field.helpText;
      group.appendChild(help);
    }

    container.appendChild(group);
  });

  updatePromptPreview();
}


// ===== render-result.js =====
// ===== RENDER RESULT =====


// ê²°ê³¼ ì´ë¯¸ì§€ ë Œë”ë§
function renderResult() {
  const container = document.getElementById('resultContainer');
  const historyContainer = document.getElementById('resultHistory');

  if (!container) return;

  // íˆìŠ¤í† ë¦¬ ë Œë”ë§
  if (historyContainer) {
    if (state.resultHistory.length > 0) {
      historyContainer.classList.remove('hidden');
      historyContainer.innerHTML = state.resultHistory.map((item, index) => `
        <div class="result-history-item ${state.selectedResultId === item.id ? 'selected' : ''}"
             onclick="selectResultHistory('${item.id}')"
             ondblclick="openImageModal(${index})">
          <img src="data:${item.image.mimeType};base64,${item.image.data}" alt="íˆìŠ¤í† ë¦¬ ${index + 1}">
        </div>
      `).join('');
    } else {
      historyContainer.classList.add('hidden');
    }
  }

  if (state.isLoading) {
    container.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">ì´ë¯¸ì§€ ìƒì„± ì¤‘...</div>
      </div>
    `;
    return;
  }

  if (state.generatedImage) {
    container.innerHTML = `
      <img
        src="data:${state.generatedImage.mimeType};base64,${state.generatedImage.data}"
        alt="ìƒì„±ëœ ì´ë¯¸ì§€"
        class="result-image"
        style="cursor: pointer;"
        onclick="openImageModal(${state.resultHistory.length - 1})"
      >
      <div class="result-actions">
        <button class="btn btn-primary" onclick="downloadImage()">
          ğŸ’¾ ë‹¤ìš´ë¡œë“œ
        </button>
        <button class="btn btn-outline" onclick="openImageModal(${state.resultHistory.length - 1})">
          ğŸ” í™•ëŒ€
        </button>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <div class="result-placeholder">
      <div class="result-placeholder-icon">ğŸ¨</div>
      <div>í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê³ <br>ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”</div>
    </div>
  `;
}


// ===== utils.js =====
// ===== UTILS =====

// ID ìƒì„± í•¨ìˆ˜ë“¤
function generateImageId() {
  return 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function generateSessionId() {
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
}

function generateCustomTemplateId() {
  return 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
}

function generateResultId() {
  return 'result_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
}

function generateHistoryId() {
  return 'history_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
}

// í¬ë§·íŒ… í•¨ìˆ˜ë“¤
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function formatRelativeTime(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
  if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
  if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
  if (diffDays < 7) return `${diffDays}ì¼ ì „`;

  return date.toLocaleDateString('ko-KR');
}

// HTML ì´ìŠ¤ì¼€ì´í”„ í—¬í¼
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, (c) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  }[c]));
}

// ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    setTimeout(() => {
      errorDiv.classList.add('hidden');
    }, 5000);
  }
}

function showSuccess(message) {
  const successDiv = document.getElementById('successMessage');
  if (successDiv) {
    successDiv.textContent = message;
    successDiv.classList.remove('hidden');
    setTimeout(() => {
      successDiv.classList.add('hidden');
    }, 3000);
  }
}

function hideError() {
  const errorDiv = document.getElementById('errorMessage');
  if (errorDiv) {
    errorDiv.classList.add('hidden');
  }
}

// ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}


// ===== render-images.js =====
// ===== RENDER IMAGES =====


// ì²¨ë¶€ ì´ë¯¸ì§€ ë Œë”ë§
function renderAttachedImages() {
  const grid = document.getElementById('thumbnailGrid');
  const countEl = document.getElementById('attachedCount');
  const infoEl = document.getElementById('selectedImageInfo');

  if (!grid || !countEl) return;

  countEl.textContent = state.attachedImages.length;

  if (state.attachedImages.length === 0) {
    grid.innerHTML = '';
    if (infoEl) infoEl.classList.add('hidden');
    return;
  }

  grid.innerHTML = state.attachedImages.map((img, index) => `
    <div class="thumbnail-item ${state.selectedImageId === img.id ? 'selected' : ''}"
         onclick="selectAttachedImage('${img.id}')">
      <img src="${img.thumbnail}" alt="ì²¨ë¶€ ${index + 1}">
      <span class="thumbnail-index">${index + 1}</span>
      <button class="thumbnail-delete" onclick="event.stopPropagation(); deleteAttachedImage('${img.id}')">&times;</button>
    </div>
  `).join('');

  // ì„ íƒëœ ì´ë¯¸ì§€ ì •ë³´ í‘œì‹œ
  if (state.selectedImageId && infoEl) {
    const selectedImg = state.attachedImages.find(img => img.id === state.selectedImageId);
    if (selectedImg) {
      infoEl.classList.remove('hidden');
      const previewEl = document.getElementById('selectedImagePreview');
      const metaEl = document.getElementById('selectedImageMeta');

      if (previewEl) {
        previewEl.src = `data:image/jpeg;base64,${selectedImg.base64}`;
      }
      if (metaEl) {
        metaEl.innerHTML = `
          <p>ğŸ“„ ${selectedImg.file.name}</p>
          <p>ğŸ“ ${selectedImg.originalWidth}Ã—${selectedImg.originalHeight} â†’ ${selectedImg.width}Ã—${selectedImg.height}</p>
          <p>ğŸ’¾ ${formatFileSize(selectedImg.originalSize)} â†’ ${formatFileSize(selectedImg.processedSize)}</p>
        `;
      }
    }
  } else if (infoEl) {
    infoEl.classList.add('hidden');
  }
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ë Œë”ë§
function renderImageModal() {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const modalPrompt = document.getElementById('modalPrompt');
  const prevBtn = document.getElementById('modalPrev');
  const nextBtn = document.getElementById('modalNext');
  const modalCounter = document.getElementById('modalCounter');

  if (!modal || state.imageModalIndex < 0) {
    if (modal) modal.classList.remove('active');
    return;
  }

  const item = state.resultHistory[state.imageModalIndex];
  if (!item) return;

  modal.classList.add('active');

  if (modalImage) {
    modalImage.src = `data:${item.image.mimeType};base64,${item.image.data}`;
  }

  if (modalPrompt) {
    modalPrompt.textContent = item.translatedPrompt || item.prompt;
  }

  if (prevBtn) {
    prevBtn.disabled = state.imageModalIndex <= 0;
  }

  if (nextBtn) {
    nextBtn.disabled = state.imageModalIndex >= state.resultHistory.length - 1;
  }

  if (modalCounter) {
    modalCounter.textContent = `${state.imageModalIndex + 1} / ${state.resultHistory.length}`;
  }
}


// ===== render-edit-session.js =====
// ===== RENDER EDIT SESSION =====


// í¸ì§‘ ì„¸ì…˜ ë Œë”ë§
function renderEditSession() {
  const sessionEl = document.getElementById('editSession');
  const historyEl = document.getElementById('editHistory');

  if (!sessionEl) return;

  if (state.editSession.editHistory.length === 0) {
    sessionEl.classList.add('hidden');
    return;
  }

  sessionEl.classList.remove('hidden');

  // í¸ì§‘ íˆìŠ¤í† ë¦¬ ë Œë”ë§
  if (historyEl) {
    historyEl.innerHTML = state.editSession.editHistory.map((item, index) => `
      <div class="edit-history-item ${index === state.editSession.currentEditIndex ? 'active' : ''}"
           onclick="selectEditHistoryItem(${index})">
        <span class="step-number">${item.step}</span>
        <div class="step-content">
          <div class="step-label">ë‹¨ê³„ ${item.step}</div>
          <div class="step-text">${item.request}</div>
        </div>
        ${item.image ? `
          <div class="step-thumb">
            <img src="data:${item.image.mimeType};base64,${item.image.data}" alt="ë‹¨ê³„ ${item.step}">
          </div>
        ` : ''}
      </div>
    `).join('');
  }

  // ë¹ ë¥¸ ìˆ˜ì • í”„ë¦¬ì…‹ ë Œë”ë§
  renderPresets();
}

// ë¹ ë¥¸ ìˆ˜ì • í”„ë¦¬ì…‹ ë Œë”ë§
function renderPresets() {
  const categoriesEl = document.getElementById('presetCategories');
  const itemsEl = document.getElementById('presetItems');

  if (!categoriesEl || !itemsEl) return;

  // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ë Œë”ë§
  categoriesEl.innerHTML = Object.values(QUICK_PRESETS).map(category => `
    <button class="preset-category-btn ${state.presetCategory === category.id ? 'active' : ''}"
            onclick="setPresetCategory('${category.id}')">
      ${category.name}
    </button>
  `).join('');

  // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¦¬ì…‹ ì•„ì´í…œ ë Œë”ë§
  const currentCategory = QUICK_PRESETS[state.presetCategory];
  if (currentCategory) {
    itemsEl.innerHTML = currentCategory.presets.map(preset => `
      <button class="preset-item" onclick="applyPreset('${preset.id}')">
        ${preset.label}
      </button>
    `).join('');
  }
}


// ===== template-handlers.js =====
// ===== TEMPLATE HANDLERS =====


// í…œí”Œë¦¿ ë³€ê²½ í•¸ë“¤ëŸ¬
function handleTemplateChange(templateId) {
  state.currentTemplate = templateId;
  renderTemplateTabs();
  renderTemplateFields();
}

// í¼ ë¦¬ì…‹
function resetForm() {
  const template = TEMPLATES[state.currentTemplate] || state.customTemplates[state.currentTemplate];
  if (!template) return;

  template.fields.forEach(field => {
    if (field.defaultValue !== undefined) {
      state.fieldValues[state.currentTemplate][field.id] = field.defaultValue;
    } else if (field.type === 'checkbox-group') {
      state.fieldValues[state.currentTemplate][field.id] = [];
    } else if (field.type === 'checkbox') {
      state.fieldValues[state.currentTemplate][field.id] = false;
    } else {
      state.fieldValues[state.currentTemplate][field.id] = '';
    }
  });
  renderTemplateFields();
}


// ===== image-processing.js =====
// ===== IMAGE PROCESSING MODULE =====


// ì´ë¯¸ì§€ ì²˜ë¦¬ (ë¦¬ì‚¬ì´ì¦ˆ, ì••ì¶•, ì¸ë„¤ì¼ ìƒì„±)
async function processImage(file, mode) {
  const config = WORK_MODES[mode];

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const originalWidth = img.width;
        const originalHeight = img.height;
        const originalSize = file.size;

        // ìµœì¢… ëª¨ë“œëŠ” ì›ë³¸ ìœ ì§€ (í•˜ì§€ë§Œ base64ë¡œ ë³€í™˜)
        if (!config.maxSize || (img.width <= config.maxSize && img.height <= config.maxSize)) {
          // ë¦¬ì‚¬ì´ì¦ˆ ë¶ˆí•„ìš”
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          const base64Full = canvas.toDataURL('image/jpeg', config.quality);
          const base64Data = base64Full.split(',')[1];

          // ì¸ë„¤ì¼ ìƒì„±
          const thumbnail = createThumbnail(img, img.width, img.height);

          resolve({
            id: generateImageId(),
            file: file,
            originalSize: originalSize,
            processedSize: Math.round(base64Data.length * 0.75),
            base64: base64Data,
            thumbnail: thumbnail,
            width: img.width,
            height: img.height,
            originalWidth: originalWidth,
            originalHeight: originalHeight
          });
        } else {
          // ë¦¬ì‚¬ì´ì¦ˆ í•„ìš”
          let newWidth, newHeight;
          if (img.width > img.height) {
            newWidth = config.maxSize;
            newHeight = Math.round(img.height * (config.maxSize / img.width));
          } else {
            newHeight = config.maxSize;
            newWidth = Math.round(img.width * (config.maxSize / img.height));
          }

          const canvas = document.createElement('canvas');
          canvas.width = newWidth;
          canvas.height = newHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, newWidth, newHeight);

          const base64Full = canvas.toDataURL('image/jpeg', config.quality);
          const base64Data = base64Full.split(',')[1];

          // ì¸ë„¤ì¼ ìƒì„±
          const thumbnail = createThumbnailFromCanvas(canvas, newWidth, newHeight);

          resolve({
            id: generateImageId(),
            file: file,
            originalSize: originalSize,
            processedSize: Math.round(base64Data.length * 0.75),
            base64: base64Data,
            thumbnail: thumbnail,
            width: newWidth,
            height: newHeight,
            originalWidth: originalWidth,
            originalHeight: originalHeight
          });
        }
      };
      img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
      img.src = e.target.result;
    };
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    reader.readAsDataURL(file);
  });
}

// ì¸ë„¤ì¼ ìƒì„± í—¬í¼ (Image ìš”ì†Œì—ì„œ)
function createThumbnail(img, width, height) {
  const thumbCanvas = document.createElement('canvas');
  const thumbSize = 100;
  thumbCanvas.width = thumbSize;
  thumbCanvas.height = thumbSize;
  const thumbCtx = thumbCanvas.getContext('2d');

  // ì •ì‚¬ê°í˜• í¬ë¡­
  const minDim = Math.min(width, height);
  const sx = (width - minDim) / 2;
  const sy = (height - minDim) / 2;
  thumbCtx.drawImage(img, sx, sy, minDim, minDim, 0, 0, thumbSize, thumbSize);

  return thumbCanvas.toDataURL('image/jpeg', 0.7);
}

// ì¸ë„¤ì¼ ìƒì„± í—¬í¼ (Canvas ìš”ì†Œì—ì„œ)
function createThumbnailFromCanvas(canvas, width, height) {
  const thumbCanvas = document.createElement('canvas');
  const thumbSize = 100;
  thumbCanvas.width = thumbSize;
  thumbCanvas.height = thumbSize;
  const thumbCtx = thumbCanvas.getContext('2d');

  const minDim = Math.min(width, height);
  const sx = (width - minDim) / 2;
  const sy = (height - minDim) / 2;
  thumbCtx.drawImage(canvas, sx, sy, minDim, minDim, 0, 0, thumbSize, thumbSize);

  return thumbCanvas.toDataURL('image/jpeg', 0.7);
}

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
function downloadImage(base64Data, mimeType, filename = 'generated-image') {
  const link = document.createElement('a');
  link.href = `data:${mimeType};base64,${base64Data}`;
  link.download = `${filename}.${mimeType.split('/')[1] || 'png'}`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// base64 ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
function base64ToBlob(base64Data, mimeType = 'image/png') {
  const byteCharacters = atob(base64Data);
  const byteNumbers = new Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNumbers);
  return new Blob([byteArray], { type: mimeType });
}

// í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ ë³µì‚¬
async function copyImageToClipboard(base64Data, mimeType) {
  try {
    const blob = base64ToBlob(base64Data, mimeType);
    await navigator.clipboard.write([
      new ClipboardItem({ [mimeType]: blob })
    ]);
    return true;
  } catch (e) {
    console.error('Failed to copy image:', e);
    return false;
  }
}


// ===== image-handlers.js =====
// ===== IMAGE HANDLERS =====


// ì‘ì—… ëª¨ë“œ ì„¤ì •
function setWorkMode(mode) {
  state.workMode = mode;

  // UI ì—…ë°ì´íŠ¸
  document.querySelectorAll('.work-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  // ê¸°ì¡´ ì²¨ë¶€ ì´ë¯¸ì§€ ì¬ì²˜ë¦¬
  if (state.attachedImages.length > 0) {
    reprocessAttachedImages();
  }
}

// ì²¨ë¶€ ì´ë¯¸ì§€ ì¬ì²˜ë¦¬
async function reprocessAttachedImages() {
  const files = state.attachedImages.map(img => img.file);
  state.attachedImages = [];

  for (const file of files) {
    try {
      const processed = await processImage(file, state.workMode);
      state.attachedImages.push(processed);
    } catch (e) {
      console.error('Image reprocessing failed:', e);
    }
  }

  renderAttachedImages();
}

// íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
async function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  await addImages(files);
  event.target.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
}

// ì´ë¯¸ì§€ ì¶”ê°€
async function addImages(files) {
  const validTypes = ['image/png', 'image/jpeg', 'image/webp', 'image/jpg'];
  const maxImages = 14;

  for (const file of files) {
    if (state.attachedImages.length >= maxImages) {
      showError(`ìµœëŒ€ ${maxImages}ê°œì˜ ì´ë¯¸ì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      break;
    }

    if (!validTypes.includes(file.type)) {
      showError(`ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹: ${file.name}`);
      continue;
    }

    try {
      const processed = await processImage(file, state.workMode);
      state.attachedImages.push(processed);
    } catch (e) {
      showError(`ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ${file.name}`);
    }
  }

  if (state.attachedImages.length > 0 && !state.selectedImageId) {
    state.selectedImageId = state.attachedImages[0].id;
  }

  renderAttachedImages();
}

// ì²¨ë¶€ ì´ë¯¸ì§€ ì„ íƒ
function selectAttachedImage(imageId) {
  state.selectedImageId = imageId;
  renderAttachedImages();
}

// ì²¨ë¶€ ì´ë¯¸ì§€ ì‚­ì œ
function deleteAttachedImage(imageId) {
  state.attachedImages = state.attachedImages.filter(img => img.id !== imageId);

  if (state.selectedImageId === imageId) {
    state.selectedImageId = state.attachedImages.length > 0 ? state.attachedImages[0].id : null;
  }

  renderAttachedImages();
}

// ì„ íƒëœ ì´ë¯¸ì§€ ì‚­ì œ
function deleteSelectedImage() {
  if (state.selectedImageId) {
    deleteAttachedImage(state.selectedImageId);
  }
}

// ì›ë³¸ ì´ë¯¸ì§€ ë³´ê¸°
function viewOriginalImage() {
  if (!state.selectedImageId) return;

  const img = state.attachedImages.find(i => i.id === state.selectedImageId);
  if (img) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('imageModalImg');
      const modalInfo = document.getElementById('imageModalInfo');

      if (modalImg) modalImg.src = e.target.result;
      if (modalInfo) modalInfo.textContent = `ì›ë³¸: ${img.originalWidth}Ã—${img.originalHeight}`;
      if (modal) modal.classList.add('active');
      state.imageModalIndex = -1; // ì²¨ë¶€ ì´ë¯¸ì§€ ëª¨ë“œ
    };
    reader.readAsDataURL(img.file);
  }
}

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
function downloadImage() {
  if (!state.generatedImage) return;

  const link = document.createElement('a');
  link.href = `data:${state.generatedImage.mimeType};base64,${state.generatedImage.data}`;
  link.download = `nano-banana-${Date.now()}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ê²°ê³¼ íˆìŠ¤í† ë¦¬ ì„ íƒ
function selectResultHistory(historyId) {
  const item = state.resultHistory.find(h => h.id === historyId);
  if (item) {
    state.selectedResultId = historyId;
    state.generatedImage = item.image;
    // renderResultëŠ” main.jsì—ì„œ í˜¸ì¶œ
  }
}


// ===== api.js =====
// ===== API MODULE =====


// API í‚¤ í…ŒìŠ¤íŠ¸
async function testApiKey(apiKey) {
  try {
    const response = await fetch(
      `${API_ENDPOINTS.TEXT}?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: 'Hello' }] }]
        })
      }
    );
    return response.ok;
  } catch (e) {
    console.error('API test failed:', e);
    return false;
  }
}

// ì´ë¯¸ì§€ ìƒì„± API í˜¸ì¶œ
async function callImageApi(prompt, apiKey, attachedImages = []) {
  // ìš”ì²­ íŒŒì¸  êµ¬ì„±
  const parts = [{ text: prompt }];

  // ì²¨ë¶€ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€
  for (const img of attachedImages) {
    if (img.base64) {
      parts.push({
        inlineData: {
          mimeType: 'image/jpeg',
          data: img.base64
        }
      });
    }
  }

  const response = await fetch(
    `${API_ENDPOINTS.IMAGE}?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: parts
        }],
        generationConfig: {
          responseModalities: ['TEXT', 'IMAGE']
        }
      })
    }
  );

  if (!response.ok) {
    const errorText = API_ERRORS[response.status] || `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (${response.status})`;
    throw new Error(errorText);
  }

  const data = await response.json();

  // ì‘ë‹µì—ì„œ ì´ë¯¸ì§€ ì¶”ì¶œ
  if (data.candidates && data.candidates[0] && data.candidates[0].content) {
    const parts = data.candidates[0].content.parts;
    for (const part of parts) {
      if (part.inlineData) {
        return {
          mimeType: part.inlineData.mimeType,
          data: part.inlineData.data
        };
      }
    }
  }

  throw new Error('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.');
}


// ===== translation.js =====
// ===== TRANSLATION MODULE =====


// í•œêµ­ì–´ â†’ ì˜ì–´ ë²ˆì—­
async function translateToEnglish(koreanText, apiKey) {
  try {
    const response = await fetch(
      `${API_ENDPOINTS.TEXT}?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: `Translate the following Korean text to English. This is a prompt for image generation, so preserve all descriptive details precisely. Only output the translated text, nothing else.\n\nKorean text:\n${koreanText}`
            }]
          }]
        })
      }
    );

    if (!response.ok) {
      throw new Error('ë²ˆì—­ ì‹¤íŒ¨');
    }

    const data = await response.json();
    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
      const text = data.candidates[0].content.parts[0].text;
      return text.trim();
    }
    throw new Error('ë²ˆì—­ ê²°ê³¼ ì—†ìŒ');
  } catch (e) {
    console.error('Translation failed:', e);
    throw e;
  }
}

// í•œêµ­ì–´ í¬í•¨ ì—¬ë¶€ í™•ì¸
function containsKorean(text) {
  const koreanRegex = /[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F]/;
  return koreanRegex.test(text);
}


// ===== generation-handlers.js =====
// ===== GENERATION HANDLERS =====


// Thinking í”„ë¦¬í”½ìŠ¤ ì ìš©
function applyThinkingPrefix(prompt) {
  if (state.thinkingMode) {
    return THINKING_PREFIX + prompt;
  }
  return prompt;
}

// ë²ˆì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateTranslateStatus(status, message) {
  const statusEl = document.getElementById('translateStatus');
  const textEl = document.getElementById('translateStatusText');

  if (!statusEl || !textEl) return;

  if (status === 'hidden') {
    statusEl.classList.add('hidden');
    return;
  }

  statusEl.classList.remove('hidden');
  statusEl.className = 'translate-status ' + status;
  textEl.textContent = message;
}

// ì´ë¯¸ì§€ ìƒì„±
async function generateImage() {
  // API í‚¤ í™•ì¸
  if (!state.apiKey) {
    showError('API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    window.openSettingsModal();
    return;
  }

  // í”„ë¡¬í”„íŠ¸ ìƒì„±
  let prompt = buildPrompt(state.currentTemplate, state.fieldValues[state.currentTemplate]);
  if (!prompt || prompt.length < 10) {
    showError('í”„ë¡¬í”„íŠ¸ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ë” ë§ì€ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  // ë¡œë”© ì‹œì‘
  state.isLoading = true;
  state.error = null;
  hideError();
  renderResult();

  const generateBtn = document.getElementById('generateBtn');
  if (generateBtn) generateBtn.disabled = true;

  try {
    // ìë™ ë²ˆì—­ì´ í™œì„±í™”ëœ ê²½ìš°
    let finalPrompt = prompt;
    let translatedPrompt = '';

    if (state.autoTranslate && containsKorean(prompt)) {
      updateTranslateStatus('translating', 'ë²ˆì—­ ì¤‘...');
      try {
        translatedPrompt = await translateToEnglish(prompt, state.apiKey);
        finalPrompt = translatedPrompt;
        state.translatedPrompt = translatedPrompt;
        updateTranslateStatus('translated', 'ë²ˆì—­ ì™„ë£Œ');
        updatePromptPreview();
      } catch (e) {
        console.error('Translation failed, using original:', e);
        updateTranslateStatus('error', 'ë²ˆì—­ ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©');
      }
    }

    // Thinking ëª¨ë“œ ì ìš©
    finalPrompt = applyThinkingPrefix(finalPrompt);

    // ì´ë¯¸ì§€ ìƒì„± API í˜¸ì¶œ (ì²¨ë¶€ ì´ë¯¸ì§€ í¬í•¨)
    const image = await callImageApi(finalPrompt, state.apiKey, state.attachedImages);
    state.generatedImage = image;

    // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    const historyItem = {
      id: generateResultId(),
      prompt: prompt,
      translatedPrompt: translatedPrompt,
      image: image,
      timestamp: new Date().toISOString()
    };
    state.resultHistory.push(historyItem);
    state.selectedResultId = historyItem.id;

    // í¸ì§‘ ì„¸ì…˜ ì´ˆê¸°í™” (ìƒˆ ì´ë¯¸ì§€ ìƒì„± ì‹œ ìƒˆ ì„¸ì…˜ ì‹œì‘)
    if (window.initEditSession) {
      window.initEditSession(finalPrompt, image);
    }

    // í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ì— ì €ì¥
    if (window.savePromptToHistory) {
      window.savePromptToHistory(prompt, translatedPrompt, state.currentTemplate);
    }

  } catch (e) {
    showError(e.message);
  } finally {
    state.isLoading = false;
    renderResult();
    if (generateBtn) generateBtn.disabled = false;
  }
}

// í”„ë¡¬í”„íŠ¸ ë³µì‚¬
function copyPrompt() {
  let textToCopy;
  if (state.promptTab === 'translated' && state.translatedPrompt) {
    textToCopy = state.translatedPrompt;
  } else {
    textToCopy = buildPrompt(state.currentTemplate, state.fieldValues[state.currentTemplate]);
  }

  if (!textToCopy) {
    showError('ë³µì‚¬í•  í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  navigator.clipboard.writeText(textToCopy).then(() => {
    // ë³µì‚¬ ì„±ê³µ í”¼ë“œë°±
    const btn = document.querySelector('.prompt-preview-header .btn-icon');
    if (btn) {
      const originalText = btn.textContent;
      btn.textContent = 'âœ…';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 1500);
    }
  }).catch(e => {
    showError('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}

// ë²ˆì—­ í† ê¸€ í•¸ë“¤ëŸ¬
function handleTranslateToggle(checked) {
  state.autoTranslate = checked;
  state.translatedPrompt = '';

  // ë²ˆì—­ íƒ­ í‘œì‹œ/ìˆ¨ê¹€
  const promptTabs = document.getElementById('promptTabs');
  if (promptTabs) {
    if (checked) {
      promptTabs.style.display = 'flex';
    } else {
      promptTabs.style.display = 'none';
      state.promptTab = 'original';
      updateTranslateStatus('hidden', '');
    }
  }

  updatePromptPreview();
}

// í”„ë¡¬í”„íŠ¸ íƒ­ ì„¤ì •
function setPromptTab(tab) {
  state.promptTab = tab;

  document.querySelectorAll('.prompt-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  updatePromptPreview();
}


// ===== modal-handlers.js =====
// ===== MODAL HANDLERS =====


// ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
function openSettingsModal() {
  const modal = document.getElementById('settingsModal');
  const apiKeyInput = document.getElementById('apiKeyInput');

  if (modal) modal.classList.add('active');
  if (apiKeyInput) apiKeyInput.value = state.apiKey;
}

// ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
function closeSettingsModal() {
  const modal = document.getElementById('settingsModal');
  if (modal) modal.classList.remove('active');
}

// API í‚¤ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
function toggleApiKeyVisibility() {
  const input = document.getElementById('apiKeyInput');
  if (input) {
    input.type = input.type === 'password' ? 'text' : 'password';
  }
}

// API ì—°ê²° í…ŒìŠ¤íŠ¸
async function testApiConnection(silent = false) {
  const apiKeyInput = document.getElementById('apiKeyInput');
  const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

  if (!apiKey) {
    if (!silent) {
      const resultEl = document.getElementById('apiTestResult');
      if (resultEl) {
        resultEl.innerHTML = `
          <div class="error-message">API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        `;
      }
    }
    return;
  }

  // í…ŒìŠ¤íŠ¸ ì¤‘ ìƒíƒœ
  updateApiStatus('testing');
  const testBtn = document.getElementById('testApiBtn');
  if (testBtn) testBtn.disabled = true;

  if (!silent) {
    const resultEl = document.getElementById('apiTestResult');
    if (resultEl) {
      resultEl.innerHTML = `
        <div class="api-status testing">
          <span class="status-dot"></span>
          <span>ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</span>
        </div>
      `;
    }
  }

  const isValid = await testApiKey(apiKey);

  if (testBtn) testBtn.disabled = false;

  if (isValid) {
    state.apiKey = apiKey;
    updateApiStatus('connected');
    if (!silent) {
      const resultEl = document.getElementById('apiTestResult');
      if (resultEl) {
        resultEl.innerHTML = `
          <div class="success-message">API ì—°ê²° ì„±ê³µ!</div>
        `;
      }
    }
  } else {
    updateApiStatus('disconnected');
    if (!silent) {
      const resultEl = document.getElementById('apiTestResult');
      if (resultEl) {
        resultEl.innerHTML = `
          <div class="error-message">API ì—°ê²° ì‹¤íŒ¨. í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>
        `;
      }
    }
  }
}

// API í‚¤ ì €ì¥
function saveApiKey() {
  const apiKeyInput = document.getElementById('apiKeyInput');
  const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

  state.apiKey = apiKey;
  saveToStorage();

  if (apiKey) {
    testApiConnection(true);
  } else {
    updateApiStatus('disconnected');
  }

  closeSettingsModal();
}

// API ìƒíƒœ ì—…ë°ì´íŠ¸
function updateApiStatus(status) {
  state.apiStatus = status;
  const statusEl = document.getElementById('apiStatus');
  const textEl = document.getElementById('apiStatusText');

  if (!statusEl || !textEl) return;

  statusEl.className = 'api-status ' + status;

  switch (status) {
    case 'connected':
      textEl.textContent = 'API ì—°ê²°ë¨';
      break;
    case 'testing':
      textEl.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
      break;
    default:
      textEl.textContent = 'API ë¯¸ì—°ê²°';
  }
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
function openImageModal(index) {
  if (index < 0 || index >= state.resultHistory.length) return;

  state.imageModalIndex = index;
  const item = state.resultHistory[index];

  const modalImg = document.getElementById('imageModalImg');
  const modalInfo = document.getElementById('imageModalInfo');
  const modal = document.getElementById('imageModal');

  if (modalImg) {
    modalImg.src = `data:${item.image.mimeType};base64,${item.image.data}`;
  }

  if (modalInfo) {
    let info = '';
    if (item.prompt) {
      info = item.prompt.substring(0, 200);
      if (item.prompt.length > 200) info += '...';
    }
    modalInfo.textContent = info;
  }

  if (modal) modal.classList.add('active');
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
function closeImageModal() {
  const modal = document.getElementById('imageModal');
  if (modal) modal.classList.remove('active');
  state.imageModalIndex = -1;
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ë„¤ë¹„ê²Œì´ì…˜
function navigateImageModal(direction) {
  if (state.imageModalIndex < 0) return;

  const newIndex = state.imageModalIndex + direction;
  if (newIndex >= 0 && newIndex < state.resultHistory.length) {
    openImageModal(newIndex);
  }
}

// ëª¨ë‹¬ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
function downloadModalImage() {
  if (state.imageModalIndex < 0 || state.imageModalIndex >= state.resultHistory.length) return;

  const item = state.resultHistory[state.imageModalIndex];
  const link = document.createElement('a');
  link.href = `data:${item.image.mimeType};base64,${item.image.data}`;
  link.download = `nano-banana-${Date.now()}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// í”„ë¡¬í”„íŠ¸ ì¬ì‚¬ìš©
function reusePrompt() {
  if (state.imageModalIndex < 0 || state.imageModalIndex >= state.resultHistory.length) return;

  const item = state.resultHistory[state.imageModalIndex];

  closeImageModal();

  // í”„ë¡¬í”„íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
  navigator.clipboard.writeText(item.prompt).then(() => {
    showError('í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ë“œì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
    setTimeout(hideError, 3000);
  });
}


// ===== edit-handlers.js =====
// ===== EDIT HANDLERS =====


// ìƒˆ ì„¸ì…˜ ì‹œì‘
function startNewSession() {
  state.editSession = {
    sessionId: generateSessionId(),
    basePrompt: '',
    editHistory: [],
    currentEditIndex: -1
  };

  const requestInput = document.getElementById('editRequestInput');
  if (requestInput) requestInput.value = '';

  renderEditSession();
}

// í¸ì§‘ ì„¸ì…˜ ì´ˆê¸°í™”
function initEditSession(prompt, image) {
  if (!state.editSession.sessionId) {
    state.editSession.sessionId = generateSessionId();
  }

  state.editSession.basePrompt = prompt;

  const historyItem = {
    id: 'edit_' + Date.now(),
    step: 1,
    request: 'ì›ë³¸ ìƒì„±',
    prompt: prompt,
    image: image,
    timestamp: new Date().toISOString()
  };

  state.editSession.editHistory = [historyItem];
  state.editSession.currentEditIndex = 0;

  renderEditSession();
}

// í¸ì§‘ íˆìŠ¤í† ë¦¬ ì¶”ê°€
function addEditHistory(request, prompt, image) {
  const step = state.editSession.editHistory.length + 1;

  const historyItem = {
    id: 'edit_' + Date.now(),
    step: step,
    request: request,
    prompt: prompt,
    image: image,
    timestamp: new Date().toISOString()
  };

  state.editSession.editHistory.push(historyItem);
  state.editSession.currentEditIndex = state.editSession.editHistory.length - 1;

  renderEditSession();
}

// í¸ì§‘ íˆìŠ¤í† ë¦¬ í•­ëª© ì„ íƒ
function selectEditHistoryItem(index) {
  if (index >= 0 && index < state.editSession.editHistory.length) {
    state.editSession.currentEditIndex = index;

    const item = state.editSession.editHistory[index];
    state.generatedImage = item.image;

    renderEditSession();
    renderResult();
  }
}

// í¸ì§‘ ìš”ì²­ ì…ë ¥ í´ë¦¬ì–´
function clearEditRequest() {
  const requestInput = document.getElementById('editRequestInput');
  if (requestInput) requestInput.value = '';
}

// í¸ì§‘ ìš”ì²­ ì ìš©
async function applyEditRequest() {
  const requestInput = document.getElementById('editRequestInput');
  const editRequest = requestInput ? requestInput.value.trim() : '';

  if (!editRequest) {
    showError('ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (!state.apiKey) {
    showError('API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    window.openSettingsModal();
    return;
  }

  if (state.editSession.editHistory.length === 0) {
    showError('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }

  // í˜„ì¬ í¸ì§‘ ë‹¨ê³„ì˜ ì´ë¯¸ì§€ì™€ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
  const currentItem = state.editSession.editHistory[state.editSession.currentEditIndex];

  // ìˆ˜ì • í”„ë¡¬í”„íŠ¸ ìƒì„±
  const editPrompt = `Based on the previous image, please modify it according to this request: ${editRequest}

Previous prompt for context: ${currentItem.prompt}`;

  // ë¡œë”© ì‹œì‘
  state.isLoading = true;
  state.error = null;
  hideError();
  renderResult();

  const applyBtn = document.getElementById('applyEditBtn');
  if (applyBtn) applyBtn.disabled = true;

  try {
    // Thinking ëª¨ë“œ ì ìš©
    let finalPrompt = applyThinkingPrefix(editPrompt);

    // ë²ˆì—­ ì ìš©
    if (state.autoTranslate && containsKorean(finalPrompt)) {
      updateTranslateStatus('translating', 'ë²ˆì—­ ì¤‘...');
      try {
        const translated = await translateToEnglish(finalPrompt, state.apiKey);
        finalPrompt = translated;
        updateTranslateStatus('translated', 'ë²ˆì—­ ì™„ë£Œ');
      } catch (e) {
        console.error('Translation failed, using original:', e);
        updateTranslateStatus('error', 'ë²ˆì—­ ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©');
      }
    }

    // ì´ì „ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ì—¬ API í˜¸ì¶œ
    const attachments = [{
      base64: currentItem.image.data
    }];

    const image = await callImageApi(finalPrompt, state.apiKey, attachments);
    state.generatedImage = image;

    // í¸ì§‘ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    addEditHistory(editRequest, finalPrompt, image);

    // ê²°ê³¼ íˆìŠ¤í† ë¦¬ì—ë„ ì¶”ê°€
    const historyItem = {
      id: generateResultId(),
      prompt: finalPrompt,
      translatedPrompt: '',
      image: image,
      timestamp: new Date().toISOString()
    };
    state.resultHistory.push(historyItem);
    state.selectedResultId = historyItem.id;

    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    if (requestInput) requestInput.value = '';

  } catch (e) {
    showError(e.message);
  } finally {
    state.isLoading = false;
    renderResult();
    if (applyBtn) applyBtn.disabled = false;
  }
}

// í”„ë¦¬ì…‹ ì¹´í…Œê³ ë¦¬ ì„¤ì •
function setPresetCategory(categoryId) {
  state.presetCategory = categoryId;
  renderPresets();
}

// í”„ë¦¬ì…‹ ì ìš©
async function applyPreset(presetId) {
  const category = QUICK_PRESETS[state.presetCategory];
  if (!category) return;

  const preset = category.presets.find(p => p.id === presetId);
  if (!preset) return;

  // í”„ë¦¬ì…‹ í”„ë¡¬í”„íŠ¸ë¥¼ í¸ì§‘ ìš”ì²­ìœ¼ë¡œ ì ìš©
  const requestInput = document.getElementById('editRequestInput');
  if (requestInput) {
    requestInput.value = preset.prompt;
  }

  // ìë™ìœ¼ë¡œ ì ìš©
  await applyEditRequest();
}

// Thinking ëª¨ë“œ í† ê¸€
function toggleThinkingMode() {
  state.thinkingMode = !state.thinkingMode;

  const toggle = document.getElementById('thinkingToggle');
  const checkbox = document.getElementById('thinkingCheckbox');

  if (state.thinkingMode) {
    if (toggle) toggle.classList.add('active');
    if (checkbox) checkbox.checked = true;
  } else {
    if (toggle) toggle.classList.remove('active');
    if (checkbox) checkbox.checked = false;
  }

  // LocalStorageì— ì €ì¥
  try {
    localStorage.setItem('nano_banana_thinking_mode', state.thinkingMode ? 'true' : 'false');
  } catch (e) {
    console.error('Failed to save thinking mode:', e);
  }
}

// Thinking ëª¨ë“œ ë¡œë“œ
function loadThinkingMode() {
  try {
    const saved = localStorage.getItem('nano_banana_thinking_mode');
    if (saved === 'true') {
      state.thinkingMode = true;
      const toggle = document.getElementById('thinkingToggle');
      const checkbox = document.getElementById('thinkingCheckbox');
      if (toggle) toggle.classList.add('active');
      if (checkbox) checkbox.checked = true;
    }
  } catch (e) {
    console.error('Failed to load thinking mode:', e);
  }
}


// ===== prompt-history.js =====
// ===== PROMPT HISTORY =====


const MAX_PROMPT_HISTORY = 100;

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ì— ì €ì¥
function savePromptToHistory(prompt, translatedPrompt, templateId) {
  const historyItem = {
    id: 'ph_' + Date.now(),
    prompt: prompt,
    translatedPrompt: translatedPrompt || '',
    templateId: templateId,
    timestamp: new Date().toISOString()
  };

  // ì¤‘ë³µ ì œê±° (ê°™ì€ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ê²ƒ ì‚­ì œ)
  state.promptHistory = state.promptHistory.filter(h => h.prompt !== prompt);

  // ë§¨ ì•ì— ì¶”ê°€
  state.promptHistory.unshift(historyItem);

  // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
  if (state.promptHistory.length > MAX_PROMPT_HISTORY) {
    state.promptHistory = state.promptHistory.slice(0, MAX_PROMPT_HISTORY);
  }

  savePromptHistory();
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ì €ì¥
function savePromptHistory() {
  try {
    localStorage.setItem(STORAGE_KEYS.PROMPT_HISTORY, JSON.stringify(state.promptHistory));
  } catch (e) {
    console.error('Failed to save prompt history:', e);
    // ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ í•­ëª© ì‚­ì œ
    if (e.name === 'QuotaExceededError') {
      state.promptHistory = state.promptHistory.slice(0, 50);
      savePromptHistory();
    }
  }
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ë¡œë“œ
function loadPromptHistory() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.PROMPT_HISTORY);
    if (saved) {
      state.promptHistory = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Failed to load prompt history:', e);
    state.promptHistory = [];
  }
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ì—´ê¸°
function openPromptHistory() {
  const modal = document.getElementById('promptHistoryModal');
  state.promptHistorySearch = '';
  renderPromptHistory();
  if (modal) modal.classList.add('active');
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
function closePromptHistory() {
  const modal = document.getElementById('promptHistoryModal');
  if (modal) modal.classList.remove('active');
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ë Œë”ë§
function renderPromptHistory() {
  const container = document.getElementById('promptHistoryList');
  const searchInput = document.getElementById('promptHistorySearch');

  if (!container) return;

  if (searchInput) {
    searchInput.value = state.promptHistorySearch;
  }

  let filteredHistory = state.promptHistory;

  // ê²€ìƒ‰ í•„í„°ë§
  if (state.promptHistorySearch) {
    const searchLower = state.promptHistorySearch.toLowerCase();
    filteredHistory = state.promptHistory.filter(h =>
      h.prompt.toLowerCase().includes(searchLower) ||
      (h.translatedPrompt && h.translatedPrompt.toLowerCase().includes(searchLower))
    );
  }

  if (filteredHistory.length === 0) {
    container.innerHTML = `
      <div class="empty-history">
        ${state.promptHistory.length === 0 ?
          'ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.' :
          'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
      </div>
    `;
    return;
  }

  container.innerHTML = filteredHistory.map(item => `
    <div class="history-item">
      <div class="history-item-content">
        <div class="history-prompt">${escapeHtml(item.prompt.substring(0, 150))}${item.prompt.length > 150 ? '...' : ''}</div>
        ${item.translatedPrompt ? `
          <div class="history-translated">ğŸŒ ${escapeHtml(item.translatedPrompt.substring(0, 100))}...</div>
        ` : ''}
        <div class="history-meta">
          <span class="history-template">${getTemplateName(item.templateId)}</span>
          <span class="history-time">${formatRelativeTime(item.timestamp)}</span>
        </div>
      </div>
      <div class="history-item-actions">
        <button class="btn btn-outline btn-sm" onclick="restorePromptFromHistory('${item.id}')" title="ë³µì›">
          â†©ï¸
        </button>
        <button class="btn btn-outline btn-sm" onclick="copyPromptFromHistory('${item.id}')" title="ë³µì‚¬">
          ğŸ“‹
        </button>
        <button class="btn btn-outline btn-sm" onclick="deletePromptFromHistory('${item.id}')" title="ì‚­ì œ">
          ğŸ—‘ï¸
        </button>
      </div>
    </div>
  `).join('');
}

// í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ê²€ìƒ‰
function searchPromptHistory(query) {
  state.promptHistorySearch = query;
  renderPromptHistory();
}

// íˆìŠ¤í† ë¦¬ì—ì„œ í”„ë¡¬í”„íŠ¸ ë³µì›
function restorePromptFromHistory(historyId) {
  const item = state.promptHistory.find(h => h.id === historyId);
  if (!item) return;

  // í•´ë‹¹ í…œí”Œë¦¿ìœ¼ë¡œ ì „í™˜
  if (item.templateId && (TEMPLATES[item.templateId] || state.customTemplates[item.templateId])) {
    handleTemplateChange(item.templateId);
  }

  // í”„ë¡¬í”„íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
  navigator.clipboard.writeText(item.prompt).then(() => {
    closePromptHistory();
    showError('í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ë“œì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
    setTimeout(hideError, 3000);
  });
}

// íˆìŠ¤í† ë¦¬ì—ì„œ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
function copyPromptFromHistory(historyId) {
  const item = state.promptHistory.find(h => h.id === historyId);
  if (!item) return;

  navigator.clipboard.writeText(item.prompt).then(() => {
    showError('í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(hideError, 2000);
  });
}

// íˆìŠ¤í† ë¦¬ì—ì„œ í”„ë¡¬í”„íŠ¸ ì‚­ì œ
function deletePromptFromHistory(historyId) {
  state.promptHistory = state.promptHistory.filter(h => h.id !== historyId);
  savePromptHistory();
  renderPromptHistory();
}

// ëª¨ë“  í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ ì‚­ì œ
function clearAllPromptHistory() {
  if (!confirm('ëª¨ë“  í”„ë¡¬í”„íŠ¸ íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  state.promptHistory = [];
  savePromptHistory();
  renderPromptHistory();
}

// í…œí”Œë¦¿ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
function getTemplateName(templateId) {
  if (TEMPLATES[templateId]) return TEMPLATES[templateId].name;
  if (state.customTemplates[templateId]) return state.customTemplates[templateId].name;
  return 'ì•Œ ìˆ˜ ì—†ìŒ';
}


// ===== canvas-generator.js =====
// ===== CANVAS GENERATOR =====


const ASPECT_RATIO_PRESETS = [
  { value: '1:1', label: '1:1', width: 1, height: 1 },
  { value: '3:4', label: '3:4', width: 3, height: 4 },
  { value: '4:3', label: '4:3', width: 4, height: 3 },
  { value: '9:16', label: '9:16', width: 9, height: 16 },
  { value: '16:9', label: '16:9', width: 16, height: 9 },
  { value: '21:9', label: '21:9', width: 21, height: 9 },
  { value: '2:3', label: '2:3', width: 2, height: 3 },
  { value: '3:2', label: '3:2', width: 3, height: 2 },
  { value: '4:5', label: '4:5', width: 4, height: 5 },
  { value: 'custom', label: 'ì»¤ìŠ¤í…€', width: null, height: null }
];

// ìº”ë²„ìŠ¤ ìƒì„±ê¸° ëª¨ë‹¬ ì—´ê¸°
function openCanvasGenerator() {
  const modal = document.getElementById('canvasGeneratorModal');
  renderAspectRatioButtons();
  renderCanvasPreview();
  updateCanvasSizeInputs();
  if (modal) modal.classList.add('active');
}

// ìº”ë²„ìŠ¤ ìƒì„±ê¸° ëª¨ë‹¬ ë‹«ê¸°
function closeCanvasGenerator() {
  const modal = document.getElementById('canvasGeneratorModal');
  if (modal) modal.classList.remove('active');
}

// ì¢…íš¡ë¹„ ì„¤ì •
function setCanvasAspectRatio(ratio) {
  state.canvasSettings.aspectRatio = ratio;

  // ì»¤ìŠ¤í…€ì´ ì•„ë‹Œ ê²½ìš° í¬ê¸° ìë™ ê³„ì‚°
  if (ratio !== 'custom') {
    const preset = ASPECT_RATIO_PRESETS.find(p => p.value === ratio);
    if (preset) {
      calculateCanvasSize(preset.width, preset.height);
    }
  }

  renderAspectRatioButtons();
  renderCanvasPreview();
  updateCanvasSizeInputs();
}

// ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚°
function calculateCanvasSize(ratioW, ratioH) {
  const baseSize = state.canvasSettings.baseSize;

  if (ratioW > ratioH) {
    // ê°€ë¡œê°€ ê¸´ ê²½ìš°
    state.canvasSettings.customWidth = baseSize;
    state.canvasSettings.customHeight = Math.round(baseSize * ratioH / ratioW);
  } else {
    // ì„¸ë¡œê°€ ê¸¸ê±°ë‚˜ ê°™ì€ ê²½ìš°
    state.canvasSettings.customHeight = baseSize;
    state.canvasSettings.customWidth = Math.round(baseSize * ratioW / ratioH);
  }
}

// ê¸°ë³¸ í¬ê¸° ì„¤ì •
function setCanvasBaseSize(size) {
  state.canvasSettings.baseSize = parseInt(size) || 1024;

  // ì¢…íš¡ë¹„ì— ë§ì¶° ì¬ê³„ì‚°
  if (state.canvasSettings.aspectRatio !== 'custom') {
    const preset = ASPECT_RATIO_PRESETS.find(p => p.value === state.canvasSettings.aspectRatio);
    if (preset && preset.width) {
      calculateCanvasSize(preset.width, preset.height);
    }
  }

  renderCanvasPreview();
  updateCanvasSizeInputs();
}

// ì»¤ìŠ¤í…€ í¬ê¸° ì„¤ì •
function setCanvasCustomSize(width, height) {
  state.canvasSettings.customWidth = parseInt(width) || 1024;
  state.canvasSettings.customHeight = parseInt(height) || 1024;
  state.canvasSettings.aspectRatio = 'custom';

  renderAspectRatioButtons();
  renderCanvasPreview();
}

// ë°°ê²½ íƒ€ì… ì„¤ì •
function setCanvasBackgroundType(type) {
  state.canvasSettings.backgroundType = type;

  if (type === 'white') {
    state.canvasSettings.backgroundColor = '#FFFFFF';
  } else if (type === 'transparent') {
    state.canvasSettings.backgroundColor = 'transparent';
  }

  renderCanvasPreview();
}

// ë°°ê²½ìƒ‰ ì„¤ì •
function setCanvasBackgroundColor(color) {
  state.canvasSettings.backgroundColor = color;
  state.canvasSettings.backgroundType = 'custom';
  renderCanvasPreview();
}

// ì¢…íš¡ë¹„ ë²„íŠ¼ ë Œë”ë§
function renderAspectRatioButtons() {
  const container = document.getElementById('aspectRatioButtons');
  if (!container) return;

  container.innerHTML = ASPECT_RATIO_PRESETS.map(preset => `
    <button class="aspect-ratio-btn ${state.canvasSettings.aspectRatio === preset.value ? 'active' : ''}"
            onclick="setCanvasAspectRatio('${preset.value}')">
      <span class="ratio-preview" style="${getRatioPreviewStyle(preset)}"></span>
      <span class="ratio-label">${preset.label}</span>
    </button>
  `).join('');
}

// ì¢…íš¡ë¹„ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ ê³„ì‚°
function getRatioPreviewStyle(preset) {
  if (preset.value === 'custom') {
    return 'width: 20px; height: 20px; border: 1px dashed var(--color-text-muted);';
  }

  const maxSize = 30;
  let w, h;

  if (preset.width > preset.height) {
    w = maxSize;
    h = Math.round(maxSize * preset.height / preset.width);
  } else {
    h = maxSize;
    w = Math.round(maxSize * preset.width / preset.height);
  }

  return `width: ${w}px; height: ${h}px; background: var(--color-border);`;
}

// í¬ê¸° ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
function updateCanvasSizeInputs() {
  const widthInput = document.getElementById('canvasWidth');
  const heightInput = document.getElementById('canvasHeight');
  if (widthInput) widthInput.value = state.canvasSettings.customWidth;
  if (heightInput) heightInput.value = state.canvasSettings.customHeight;
}

// ìº”ë²„ìŠ¤ í”„ë¦¬ë·° ë Œë”ë§
function renderCanvasPreview() {
  const canvas = document.getElementById('canvasPreview');
  const infoEl = document.getElementById('canvasInfo');
  if (!canvas || !infoEl) return;

  const ctx = canvas.getContext('2d');
  const width = state.canvasSettings.customWidth;
  const height = state.canvasSettings.customHeight;

  // í”„ë¦¬ë·° ìº”ë²„ìŠ¤ í¬ê¸° (ë¹„ìœ¨ ìœ ì§€í•˜ë©° ì»¨í…Œì´ë„ˆì— ë§ì¶¤)
  const maxPreviewSize = 200;
  let previewWidth, previewHeight;

  if (width > height) {
    previewWidth = maxPreviewSize;
    previewHeight = Math.round(maxPreviewSize * height / width);
  } else {
    previewHeight = maxPreviewSize;
    previewWidth = Math.round(maxPreviewSize * width / height);
  }

  canvas.width = previewWidth;
  canvas.height = previewHeight;

  // ë°°ê²½ ê·¸ë¦¬ê¸°
  if (state.canvasSettings.backgroundType === 'transparent') {
    // ì²´ì»¤ë³´ë“œ íŒ¨í„´ (íˆ¬ëª… í‘œì‹œ)
    const tileSize = 10;
    for (let y = 0; y < previewHeight; y += tileSize) {
      for (let x = 0; x < previewWidth; x += tileSize) {
        ctx.fillStyle = ((x + y) / tileSize) % 2 === 0 ? '#FFFFFF' : '#CCCCCC';
        ctx.fillRect(x, y, tileSize, tileSize);
      }
    }
  } else {
    ctx.fillStyle = state.canvasSettings.backgroundColor;
    ctx.fillRect(0, 0, previewWidth, previewHeight);
  }

  // í…Œë‘ë¦¬
  ctx.strokeStyle = '#CCCCCC';
  ctx.strokeRect(0, 0, previewWidth, previewHeight);

  // ì •ë³´ í‘œì‹œ
  infoEl.textContent = `${width} Ã— ${height}px`;
}

// ìº”ë²„ìŠ¤ ìƒì„± ë° ì²¨ë¶€
async function generateAndAttachCanvas() {
  const width = state.canvasSettings.customWidth;
  const height = state.canvasSettings.customHeight;

  // ì‹¤ì œ í¬ê¸° ìº”ë²„ìŠ¤ ìƒì„±
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');

  if (state.canvasSettings.backgroundType === 'transparent') {
    // íˆ¬ëª… ë°°ê²½
    ctx.clearRect(0, 0, width, height);
  } else {
    ctx.fillStyle = state.canvasSettings.backgroundColor;
    ctx.fillRect(0, 0, width, height);
  }

  // Blobìœ¼ë¡œ ë³€í™˜
  const blob = await new Promise(resolve => {
    canvas.toBlob(resolve, 'image/png');
  });

  // File ê°ì²´ ìƒì„±
  const file = new File([blob], `canvas-${width}x${height}.png`, { type: 'image/png' });

  // ì²¨ë¶€ ì´ë¯¸ì§€ì— ì¶”ê°€
  await addImages([file]);

  // ëª¨ë‹¬ ë‹«ê¸°
  closeCanvasGenerator();

  // ì•ˆë‚´ ë©”ì‹œì§€
  showError(`${width}Ã—${height} ìº”ë²„ìŠ¤ê°€ ì²¨ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  setTimeout(hideError, 2000);
}


// ===== custom-templates.js =====
// ===== CUSTOM TEMPLATES =====


// ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì €ì¥
function saveCustomTemplates() {
  try {
    localStorage.setItem(STORAGE_KEYS.CUSTOM_TEMPLATES, JSON.stringify(state.customTemplates));
  } catch (e) {
    console.error('Failed to save custom templates:', e);
    showError('í…œí”Œë¦¿ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  }
}

// ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ë¡œë“œ
function loadCustomTemplates() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.CUSTOM_TEMPLATES);
    if (saved) {
      state.customTemplates = JSON.parse(saved);
      // ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì˜ fieldValues ì´ˆê¸°í™”
      Object.keys(state.customTemplates).forEach(templateId => {
        if (!state.fieldValues[templateId]) {
          initializeCustomTemplateFieldValues(templateId, state.customTemplates[templateId]);
        }
      });
    }
  } catch (e) {
    console.error('Failed to load custom templates:', e);
  }
}

// í•„ë“œ ê°’ ì´ˆê¸°í™” í—¬í¼
function initFieldValue(templateId, field) {
  if (field.defaultValue !== undefined) {
    state.fieldValues[templateId][field.id] = field.defaultValue;
  } else if (field.type === 'checkbox-group') {
    state.fieldValues[templateId][field.id] = [];
  } else if (field.type === 'checkbox') {
    state.fieldValues[templateId][field.id] = false;
  } else {
    state.fieldValues[templateId][field.id] = '';
  }
}

// í…œí”Œë¦¿ ì—ë””í„° ì—´ê¸°
function openTemplateEditor(templateId = null) {
  const modal = document.getElementById('templateEditorModal');
  if (!modal) return;

  if (templateId && state.customTemplates[templateId]) {
    // ê¸°ì¡´ í…œí”Œë¦¿ í¸ì§‘
    state.editingTemplate = templateId;
    const template = state.customTemplates[templateId];
    document.getElementById('templateName').value = template.name;
    document.getElementById('templateIcon').value = template.icon;
    document.getElementById('templateCategory').value = template.category || 'custom';
    document.getElementById('templateDescription').value = template.description || '';
    document.getElementById('templatePrompt').value = template.promptTemplate;
    state.templateEditorFields = JSON.parse(JSON.stringify(template.fields));
  } else {
    // ìƒˆ í…œí”Œë¦¿ ìƒì„±
    state.editingTemplate = null;
    document.getElementById('templateName').value = '';
    document.getElementById('templateIcon').value = 'ğŸ¨';
    document.getElementById('templateCategory').value = 'custom';
    document.getElementById('templateDescription').value = '';
    document.getElementById('templatePrompt').value = '';
    state.templateEditorFields = [];
  }

  renderTemplateEditorFields();
  modal.classList.add('active');
}

// í…œí”Œë¦¿ ì—ë””í„° ë‹«ê¸°
function closeTemplateEditor() {
  const modal = document.getElementById('templateEditorModal');
  if (modal) modal.classList.remove('active');
  state.editingTemplate = null;
  state.templateEditorFields = [];
}

// ì—ë””í„° í•„ë“œ ì¶”ê°€
function addEditorField() {
  const newField = {
    id: 'field_' + Date.now(),
    label: 'ìƒˆ í•„ë“œ',
    type: 'text',
    placeholder: '',
    helpText: '',
    required: false,
    options: []
  };
  state.templateEditorFields.push(newField);
  renderTemplateEditorFields();
}

// ì—ë””í„° í•„ë“œ ì‚­ì œ
function deleteEditorField(index) {
  state.templateEditorFields.splice(index, 1);
  renderTemplateEditorFields();
}

// ì—ë””í„° í•„ë“œ ì´ë™
function moveEditorField(index, direction) {
  const newIndex = index + direction;
  if (newIndex < 0 || newIndex >= state.templateEditorFields.length) return;

  const temp = state.templateEditorFields[index];
  state.templateEditorFields[index] = state.templateEditorFields[newIndex];
  state.templateEditorFields[newIndex] = temp;
  renderTemplateEditorFields();
}

// ì—ë””í„° í•„ë“œ ì—…ë°ì´íŠ¸
function updateEditorField(index, property, value) {
  state.templateEditorFields[index][property] = value;

  // ë¼ë²¨ ë³€ê²½ ì‹œ ID ìë™ ìƒì„±
  if (property === 'label' && !state.templateEditorFields[index].idManuallySet) {
    state.templateEditorFields[index].id = value.toLowerCase()
      .replace(/[^a-z0-9ê°€-í£]/g, '_')
      .replace(/_+/g, '_')
      .replace(/^_|_$/g, '') || 'field_' + Date.now();
  }

  renderTemplateEditorFields();
}

// í•„ë“œ ì˜µì…˜ ì¶”ê°€
function addFieldOption(fieldIndex) {
  if (!state.templateEditorFields[fieldIndex].options) {
    state.templateEditorFields[fieldIndex].options = [];
  }
  state.templateEditorFields[fieldIndex].options.push({
    value: '',
    label: ''
  });
  renderTemplateEditorFields();
}

// í•„ë“œ ì˜µì…˜ ì‚­ì œ
function deleteFieldOption(fieldIndex, optionIndex) {
  state.templateEditorFields[fieldIndex].options.splice(optionIndex, 1);
  renderTemplateEditorFields();
}

// í•„ë“œ íƒ€ì… ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
function getFieldTypeName(type) {
  const names = {
    'text': 'í…ìŠ¤íŠ¸',
    'textarea': 'ì˜ì—­',
    'select': 'ì„ íƒ',
    'checkbox': 'ì²´í¬',
    'checkbox-group': 'ê·¸ë£¹'
  };
  return names[type] || type;
}

// í…œí”Œë¦¿ ì—ë””í„° í•„ë“œ ë Œë”ë§
function renderTemplateEditorFields() {
  const container = document.getElementById('templateFieldsEditor');
  const placeholdersContainer = document.getElementById('fieldPlaceholders');

  if (!container) return;

  if (state.templateEditorFields.length === 0) {
    container.innerHTML = '<div class="empty-fields-message">í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. "í•„ë“œ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>';
    if (placeholdersContainer) placeholdersContainer.innerHTML = '';
    return;
  }

  container.innerHTML = state.templateEditorFields.map((field, index) => `
    <div class="editor-field-item">
      <div class="editor-field-header">
        <span class="field-drag-handle">â‹®â‹®</span>
        <span class="field-type-badge">${getFieldTypeName(field.type)}</span>
        <span class="field-label-preview">{${field.id}}</span>
        <div class="field-actions">
          <button class="btn btn-outline btn-sm" onclick="moveEditorField(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â–²</button>
          <button class="btn btn-outline btn-sm" onclick="moveEditorField(${index}, 1)" ${index === state.templateEditorFields.length - 1 ? 'disabled' : ''}>â–¼</button>
          <button class="btn btn-outline btn-sm btn-danger" onclick="deleteEditorField(${index})">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="editor-field-body">
        <div class="field-row">
          <div class="field-col">
            <label>ë¼ë²¨</label>
            <input type="text" class="form-input" value="${escapeHtml(field.label)}"
                   oninput="updateEditorField(${index}, 'label', this.value)">
          </div>
          <div class="field-col">
            <label>ID</label>
            <input type="text" class="form-input" value="${escapeHtml(field.id)}"
                   oninput="updateEditorField(${index}, 'id', this.value); state.templateEditorFields[${index}].idManuallySet = true;">
          </div>
          <div class="field-col">
            <label>íƒ€ì…</label>
            <select class="form-select" onchange="updateEditorField(${index}, 'type', this.value)">
              <option value="text" ${field.type === 'text' ? 'selected' : ''}>í…ìŠ¤íŠ¸</option>
              <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>í…ìŠ¤íŠ¸ì˜ì—­</option>
              <option value="select" ${field.type === 'select' ? 'selected' : ''}>ì„ íƒ</option>
              <option value="checkbox" ${field.type === 'checkbox' ? 'selected' : ''}>ì²´í¬ë°•ìŠ¤</option>
              <option value="checkbox-group" ${field.type === 'checkbox-group' ? 'selected' : ''}>ì²´í¬ë°•ìŠ¤ ê·¸ë£¹</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <div class="field-col">
            <label>Placeholder</label>
            <input type="text" class="form-input" value="${escapeHtml(field.placeholder || '')}"
                   oninput="updateEditorField(${index}, 'placeholder', this.value)">
          </div>
          <div class="field-col-sm">
            <label>í•„ìˆ˜</label>
            <input type="checkbox" ${field.required ? 'checked' : ''}
                   onchange="updateEditorField(${index}, 'required', this.checked)">
          </div>
        </div>
        <div class="field-row">
          <div class="field-col">
            <label>ë„ì›€ë§</label>
            <input type="text" class="form-input" value="${escapeHtml(field.helpText || '')}"
                   oninput="updateEditorField(${index}, 'helpText', this.value)">
          </div>
        </div>
        ${(field.type === 'select' || field.type === 'checkbox-group') ? `
          <div class="field-options">
            <label>ì˜µì…˜</label>
            ${(field.options || []).map((opt, optIndex) => `
              <div class="option-row">
                <input type="text" class="form-input" placeholder="ê°’" value="${escapeHtml(opt.value)}"
                       oninput="state.templateEditorFields[${index}].options[${optIndex}].value = this.value">
                <input type="text" class="form-input" placeholder="ë¼ë²¨" value="${escapeHtml(opt.label)}"
                       oninput="state.templateEditorFields[${index}].options[${optIndex}].label = this.value">
                <button class="btn btn-outline btn-sm" onclick="deleteFieldOption(${index}, ${optIndex})">Ã—</button>
              </div>
            `).join('')}
            <button class="btn btn-outline btn-sm" onclick="addFieldOption(${index})">+ ì˜µì…˜ ì¶”ê°€</button>
          </div>
        ` : ''}
      </div>
    </div>
  `).join('');

  // í•„ë“œ í”Œë ˆì´ìŠ¤í™€ë” ë²„íŠ¼ ë Œë”ë§
  if (placeholdersContainer) {
    placeholdersContainer.innerHTML = state.templateEditorFields.map(field => `
      <button class="field-placeholder-btn" onclick="insertFieldPlaceholder('${field.id}')">{${field.id}}</button>
    `).join('');
  }
}

// í•„ë“œ í”Œë ˆì´ìŠ¤í™€ë” ì‚½ì…
function insertFieldPlaceholder(fieldId) {
  const textarea = document.getElementById('templatePrompt');
  if (!textarea) return;

  const placeholder = `{${fieldId}}`;
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;

  textarea.value = text.substring(0, start) + placeholder + text.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + placeholder.length;
}

// í…œí”Œë¦¿ ì €ì¥
function saveTemplate() {
  const name = document.getElementById('templateName').value.trim();
  const icon = document.getElementById('templateIcon').value.trim() || 'ğŸ¨';
  const category = document.getElementById('templateCategory').value;
  const description = document.getElementById('templateDescription').value.trim();
  const promptTemplate = document.getElementById('templatePrompt').value.trim();

  // ìœ íš¨ì„± ê²€ì‚¬
  if (!name) {
    showError('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  if (state.templateEditorFields.length === 0) {
    showError('ìµœì†Œ 1ê°œì˜ í•„ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  if (!promptTemplate) {
    showError('í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const templateId = state.editingTemplate || generateCustomTemplateId();

  const template = {
    id: templateId,
    name: name,
    icon: icon,
    category: category,
    description: description,
    isCustom: true,
    createdAt: state.editingTemplate ? state.customTemplates[templateId].createdAt : new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    fields: state.templateEditorFields.map(f => ({
      id: f.id,
      label: f.label,
      type: f.type,
      placeholder: f.placeholder || '',
      helpText: f.helpText || '',
      required: f.required || false,
      options: f.options || []
    })),
    promptTemplate: promptTemplate
  };

  state.customTemplates[templateId] = template;

  // fieldValues ì´ˆê¸°í™”
  state.fieldValues[templateId] = {};
  template.fields.forEach(field => {
    initFieldValue(templateId, field);
  });

  saveCustomTemplates();
  closeTemplateEditor();
  renderTemplateTabs();

  // ìƒˆë¡œ ë§Œë“  í…œí”Œë¦¿ìœ¼ë¡œ ì „í™˜
  handleTemplateChange(templateId);

  showError(state.editingTemplate ? 'í…œí”Œë¦¿ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í…œí”Œë¦¿ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
  setTimeout(hideError, 2000);
}

// í…œí”Œë¦¿ ë³µì œ
function duplicateTemplate(templateId) {
  let sourceTemplate;

  if (TEMPLATES[templateId]) {
    sourceTemplate = TEMPLATES[templateId];
  } else if (state.customTemplates[templateId]) {
    sourceTemplate = state.customTemplates[templateId];
  } else {
    showError('í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const newId = generateCustomTemplateId();
  const newTemplate = {
    ...JSON.parse(JSON.stringify(sourceTemplate)),
    id: newId,
    name: sourceTemplate.name + ' (ë³µì‚¬ë³¸)',
    isCustom: true,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  state.customTemplates[newId] = newTemplate;

  // fieldValues ì´ˆê¸°í™”
  state.fieldValues[newId] = {};
  newTemplate.fields.forEach(field => {
    initFieldValue(newId, field);
  });

  saveCustomTemplates();
  renderTemplateTabs();

  showError('í…œí”Œë¦¿ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  setTimeout(hideError, 2000);
}

// ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì‚­ì œ
function deleteCustomTemplate(templateId) {
  if (!state.customTemplates[templateId]) {
    showError('ì‚­ì œí•  í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  if (!confirm(`"${state.customTemplates[templateId].name}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }

  delete state.customTemplates[templateId];
  delete state.fieldValues[templateId];

  // í˜„ì¬ ì„ íƒëœ í…œí”Œë¦¿ì´ ì‚­ì œëœ ê²ƒì´ë©´ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ì „í™˜
  if (state.currentTemplate === templateId) {
    state.currentTemplate = 'basic';
  }

  saveCustomTemplates();
  renderTemplateTabs();
  renderTemplateFields();

  showError('í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  setTimeout(hideError, 2000);
}

// í…œí”Œë¦¿ ë‚´ë³´ë‚´ê¸°
function exportTemplate(templateId) {
  const template = state.customTemplates[templateId];
  if (!template) {
    showError('í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const exportData = JSON.stringify(template, null, 2);
  const blob = new Blob([exportData], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = `template-${template.name.replace(/[^a-z0-9ê°€-í£]/gi, '-')}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// í…œí”Œë¦¿ ê°€ì ¸ì˜¤ê¸°
function importTemplate(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const template = JSON.parse(e.target.result);

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!template.name || !template.fields || !template.promptTemplate) {
        throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ í…œí”Œë¦¿ íŒŒì¼ì…ë‹ˆë‹¤.');
      }

      const newId = generateCustomTemplateId();
      template.id = newId;
      template.isCustom = true;
      template.createdAt = new Date().toISOString();
      template.updatedAt = new Date().toISOString();

      state.customTemplates[newId] = template;

      // fieldValues ì´ˆê¸°í™”
      state.fieldValues[newId] = {};
      template.fields.forEach(field => {
        initFieldValue(newId, field);
      });

      saveCustomTemplates();
      renderTemplateTabs();

      showError('í…œí”Œë¦¿ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
      setTimeout(hideError, 2000);
    } catch (err) {
      showError('í…œí”Œë¦¿ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
    }
  };
  reader.readAsText(file);
}


// ===== main.js =====
// ===== MAIN.JS - Entry Point =====

// Core modules

// UI modules

// Handler modules

// Feature modules

// ===== Register Global Functions for onclick handlers =====
window.handleTemplateChange = handleTemplateChange;
window.resetForm = resetForm;

// Image handlers
window.setWorkMode = setWorkMode;
window.handleFileSelect = handleFileSelect;
window.selectAttachedImage = selectAttachedImage;
window.deleteAttachedImage = deleteAttachedImage;
window.deleteSelectedImage = deleteSelectedImage;
window.viewOriginalImage = viewOriginalImage;
window.downloadImage = downloadImage;
window.selectResultHistory = (historyId) => {
  selectResultHistory(historyId);
  renderResult();
};

// Generation handlers
window.generateImage = generateImage;
window.copyPrompt = copyPrompt;
window.handleTranslateToggle = handleTranslateToggle;
window.setPromptTab = setPromptTab;

// Modal handlers
window.openSettingsModal = openSettingsModal;
window.closeSettingsModal = closeSettingsModal;
window.toggleApiKeyVisibility = toggleApiKeyVisibility;
window.testApiConnection = testApiConnection;
window.saveApiKey = saveApiKey;
window.openImageModal = openImageModal;
window.closeImageModal = closeImageModal;
window.navigateImageModal = navigateImageModal;
window.downloadModalImage = downloadModalImage;
window.reusePrompt = reusePrompt;

// Edit handlers
window.startNewSession = startNewSession;
window.initEditSession = initEditSession;
window.selectEditHistoryItem = selectEditHistoryItem;
window.clearEditRequest = clearEditRequest;
window.applyEditRequest = applyEditRequest;
window.setPresetCategory = setPresetCategory;
window.applyPreset = applyPreset;
window.toggleThinkingMode = toggleThinkingMode;

// Prompt history handlers
window.savePromptToHistory = savePromptToHistory;
window.openPromptHistory = openPromptHistory;
window.closePromptHistory = closePromptHistory;
window.searchPromptHistory = searchPromptHistory;
window.restorePromptFromHistory = restorePromptFromHistory;
window.copyPromptFromHistory = copyPromptFromHistory;
window.deletePromptFromHistory = deletePromptFromHistory;
window.clearAllPromptHistory = clearAllPromptHistory;

// Canvas generator handlers
window.openCanvasGenerator = openCanvasGenerator;
window.closeCanvasGenerator = closeCanvasGenerator;
window.setCanvasAspectRatio = setCanvasAspectRatio;
window.setCanvasBaseSize = setCanvasBaseSize;
window.setCanvasCustomSize = setCanvasCustomSize;
window.setCanvasBackgroundType = setCanvasBackgroundType;
window.setCanvasBackgroundColor = setCanvasBackgroundColor;
window.generateAndAttachCanvas = generateAndAttachCanvas;

// Custom template handlers
window.openTemplateEditor = openTemplateEditor;
window.closeTemplateEditor = closeTemplateEditor;
window.addEditorField = addEditorField;
window.deleteEditorField = deleteEditorField;
window.moveEditorField = moveEditorField;
window.updateEditorField = updateEditorField;
window.addFieldOption = addFieldOption;
window.deleteFieldOption = deleteFieldOption;
window.saveTemplate = saveTemplate;
window.duplicateTemplate = duplicateTemplate;
window.deleteCustomTemplate = deleteCustomTemplate;
window.exportTemplate = exportTemplate;
window.insertFieldPlaceholder = insertFieldPlaceholder;

// State access (for inline handlers)
window.state = state;

// ===== App Initialization =====
function initApp() {
  // 1. Initialize field values for all templates
  initializeFieldValues();

  // 2. Load saved data from localStorage
  const savedApiKey = loadFromStorage();
  loadSettings();
  loadPromptHistory();
  loadCustomTemplates();
  loadThinkingMode();

  // 3. Test API connection if key exists
  if (savedApiKey) {
    testApiConnection(true);
  }

  // 4. Render initial UI
  renderTemplateTabs();
  renderTemplateFields();
  renderResult();
  renderAttachedImages();

  // 5. Setup drag and drop for image upload
  setupDragAndDrop();

  // 6. Setup keyboard shortcuts
  setupKeyboardShortcuts();

  console.log('Nano Banana Assistant initialized');
}

// Setup drag and drop for image upload
function setupDragAndDrop() {
  const uploadArea = document.getElementById('uploadArea');
  if (!uploadArea) return;

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => {
      uploadArea.classList.add('drag-over');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => {
      uploadArea.classList.remove('drag-over');
    });
  });

  uploadArea.addEventListener('drop', async (e) => {
    const files = Array.from(e.dataTransfer.files);
    await addImages(files);
  });
}

// Setup keyboard shortcuts
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // ESC to close modals
    if (e.key === 'Escape') {
      closeSettingsModal();
      closeImageModal();
      closePromptHistory();
      closeCanvasGenerator();
      closeTemplateEditor();
    }

    // Arrow keys for image modal navigation
    if (state.imageModalIndex >= 0) {
      if (e.key === 'ArrowLeft') {
        navigateImageModal(-1);
      } else if (e.key === 'ArrowRight') {
        navigateImageModal(1);
      }
    }

    // Ctrl/Cmd + Enter to generate
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      generateImage();
    }
  });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initApp);


})();
  </script>
</body>
</html>